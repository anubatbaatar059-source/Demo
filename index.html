<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR — Intro → Меню → Дасгал</title>
  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}
    #tapToStart{position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:var(--z-ui);cursor:pointer}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}
    #hint{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);z-index:var(--z-ui);color:#fff;background:rgba(0,0,0,.55);padding:10px 14px;border-radius:12px;display:none}
    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:6px;font:12px/1.25 monospace;white-space:pre-wrap;max-width:92vw}
  </style>

  <!-- libs -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>
  <!-- main -->
  <script defer>
    const INTRO_WEBM_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL     = "";
    const EXERCISE_WEBM_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL  = "";

    const dbgEl = document.createElement('div');
    dbgEl.id = 'debug'; dbgEl.textContent = 'DEBUG: booting…';
    document.addEventListener('DOMContentLoaded', ()=> document.body.appendChild(dbgEl));
    const dbg = (m)=>{ dbgEl.textContent = 'DEBUG: ' + m; };

    let THREEJS, ZT, renderer, camera, scene, tracker, anchor, plane;
    let hasPlaced=false, texIntro, texEx, currentVideo;
    let baseH=0.9, scaleFactor=1.2, spinSpeed=0.9*Math.PI/180;
    const MIN_S=0.3, MAX_S=3;

    function setSources(el, webm, mp4=""){
      el.crossOrigin="anonymous"; el.setAttribute('playsinline',''); el.innerHTML="";
      const canWebM = el.canPlayType?.('video/webm; codecs="vp8,opus"');
      if (webm && canWebM){ const s=document.createElement('source'); s.src=webm; s.type='video/webm; codecs="vp8,opus"'; el.appendChild(s); }
      if (mp4){ const s=document.createElement('source'); s.src=mp4; s.type='video/mp4'; el.appendChild(s); }
      el.onerror=()=>dbg('VIDEO ERROR url='+ (el.currentSrc||'-'));
      el.load();
    }
    function videoTexture(el){ const t=new THREEJS.VideoTexture(el); t.colorSpace=THREEJS.SRGBColorSpace; t.flipY=false; return t; }
    function applyScale(){ plane.scale.set(scaleFactor,scaleFactor,1); plane.position.y=(baseH*scaleFactor)/2; }
    function fitPlaneToVideo(el){ const w=el.videoWidth||1280, h=el.videoHeight||720; baseH=0.9; const W=baseH*(w/h); plane.geometry.dispose(); plane.geometry=new THREEJS.PlaneGeometry(W,baseH); applyScale(); }
    const _eul=new THREEJS.Euler(0,0,0,'YXZ');
    function faceCameraYawOnly(){ _eul.setFromQuaternion(camera.quaternion,'YXZ'); _eul.x=0; _eul.z=0; plane.quaternion.setFromEuler(_eul); }
    function upright(){ _eul.setFromQuaternion(plane.quaternion,'YXZ'); _eul.x=0; _eul.z=0; plane.quaternion.setFromEuler(_eul); }

    async function ensureCamera(){
      if (!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia unsupported');
      try {
        // зөвшөөрөл асуух
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
        s.getTracks().forEach(t=>t.stop());
      } catch(e){ throw new Error('camera permission denied or blocked'); }
      try{ camera.start(); }catch{}
      dbg('camera started');
    }

    function hookGestures(){
      let pinch={active:false,startDist:0,startScale:1,startAngle:0,startYaw:0};
      let drag ={active:false,startX:0,startYaw:0};
      const dist2=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
      const angle2=(a,b)=>Math.atan2(b.clientY-a.clientY,b.clientX-a.clientX);

      addEventListener('touchstart', e=>{
        if (!hasPlaced) return;
        if (e.touches.length===2){
          pinch={active:true,startDist:dist2(e.touches[0],e.touches[1]),startScale:scaleFactor,startAngle:angle2(e.touches[0],e.touches[1]),startYaw:plane.rotation.y};
        } else if (e.touches.length===1){
          drag={active:true,startX:e.touches[0].clientX,startYaw:plane.rotation.y};
        }
      },{passive:true});
      addEventListener('touchmove', e=>{
        if (!hasPlaced) return;
        if (pinch.active && e.touches.length===2){
          const k = dist2(e.touches[0], e.touches[1])/(pinch.startDist||1);
          scaleFactor=Math.min(MAX_S,Math.max(MIN_S,pinch.startScale*k));
          const ang = angle2(e.touches[0], e.touches[1]);
          plane.rotation.y=pinch.startYaw+(ang-pinch.startAngle); upright(); applyScale();
        } else if (drag.active && e.touches.length===1){
          const dx=e.touches[0].clientX-drag.startX;
          plane.rotation.y=drag.startYaw+dx*0.004; upright();
        }
      },{passive:true});
      addEventListener('touchend', e=>{ if (e.touches.length<2) pinch.active=false; if (e.touches.length===0) drag.active=false; }, {passive:true});
      addEventListener('wheel', e=>{ if (!hasPlaced) return; scaleFactor=Math.min(MAX_S,Math.max(MIN_S,scaleFactor*(e.deltaY>0?0.95:1.05))); applyScale(); }, {passive:true});
      addEventListener('pointerdown', e=>{ if (!hasPlaced) return; drag={active:true,startX:e.clientX,startYaw:plane.rotation.y}; });
      addEventListener('pointermove', e=>{ if (!hasPlaced||!drag.active) return; const dx=e.clientX-drag.startX; plane.rotation.y=drag.startYaw+dx*0.004; upright(); });
      addEventListener('pointerup', ()=>{ drag.active=false; });
    }

    async function bootstrap(){
      try{
        THREEJS = window.THREE;
        ZT = window.ZapparThree;
        if (!THREEJS || !ZT){ dbg('libs not loaded'); return; }

        if (ZT.browserIncompatible()){ ZT.browserIncompatibleUI(); dbg('browser incompatible'); return; }

        renderer = new THREEJS.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
        renderer.setSize(innerWidth, innerHeight);
        renderer.domElement.classList.add('webgl');
        document.body.appendChild(renderer.domElement);
        addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
        ZT.glContextSet(renderer.getContext());
        dbg('renderer ok');

        camera = new ZT.Camera({ userFacing:false });
        scene  = new THREEJS.Scene();
        scene.background = camera.backgroundTexture;

        tracker = new ZT.InstantWorldTracker();
        anchor  = new ZT.InstantWorldAnchorGroup(camera, tracker);
        scene.add(anchor);

        plane = new THREEJS.Mesh(
          new THREEJS.PlaneGeometry(1,1),
          new THREEJS.MeshBasicMaterial({ transparent:true, side: THREEJS.DoubleSide })
        );
        anchor.add(plane);

        renderer.setAnimationLoop(()=>{
          if (!hasPlaced){
            tracker.setAnchorPoseFromCameraOffset(0,0,-2);
            const eul=new THREEJS.Euler().setFromQuaternion(camera.quaternion,'YXZ');
            eul.x=0; eul.z=0; plane.quaternion.setFromEuler(eul);
            plane.rotation.y += spinSpeed;
          }
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        });

        document.addEventListener('visibilitychange', ()=>{ if (!document.hidden){ try{camera.start();}catch{} } else { try{camera.pause();}catch{} } });

        hookGestures();
        dbg('bootstrap ready');

        await autoStart();
      }catch(e){
        dbg('BOOT ERROR: ' + (e?.message||e));
        // gesture fallback
        document.getElementById('tapToStart').style.display='grid';
      }
    }

    async function autoStart(){
      const vIntro = document.getElementById('vidIntro');
      const vEx    = document.getElementById('vidExercise');
      const btnUnmute = document.getElementById('btnUnmute');
      const menu = document.getElementById('menu');
      const hint = document.getElementById('hint');

      try{
        await ensureCamera();

        setSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setSources(vEx,    EXERCISE_WEBM_URL, EXERCISE_MP4_URL);
        texIntro = texIntro || videoTexture(vIntro);
        texEx    = texEx    || videoTexture(vEx);

        currentVideo = vIntro;
        plane.material.map = texIntro;
        hasPlaced=false; scaleFactor=1.2; applyScale();

        if (vIntro.readyState>=1) fitPlaneToVideo(vIntro);
        else vIntro.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vIntro), {once:true});

        try{ vIntro.muted=false; await vIntro.play(); btnUnmute.style.display='none'; }
        catch{ vIntro.muted=true; vIntro.play().catch(()=>{}); btnUnmute.style.display='inline-block'; }

        const place=()=>{ hasPlaced=true; spinSpeed=0; removeEventListener('pointerdown', place); hint.style.display='none'; dbg('intro placed'); };
        addEventListener('pointerdown', place, {once:true, passive:true});
        hint.style.display='block';
        vIntro.onended=()=>{ menu.style.display='flex'; hint.style.display='none'; dbg('intro ended → menu'); };

        dbg('ready');
      }catch(e){
        dbg('need user gesture (tap): '+(e?.message||e));
        document.getElementById('tapToStart').style.display='grid';
      }
    }

    window.addEventListener('load', bootstrap);

    // Fallback tap to start
    document.addEventListener('DOMContentLoaded', ()=>{
      const tap = document.createElement('div');
      tap.id='tapToStart';
      tap.innerHTML = '<button class="btn">▶ Камер нээх</button>';
      document.body.appendChild(tap);
      tap.addEventListener('pointerdown', async ()=>{
        tap.style.display='none';
        try{ await autoStart(); }catch(e){ dbg('after tap failed: '+(e?.message||e)); }
      });
    });
  </script>
</head>
<body>
  <button id="btnUnmute" class="btn">🔊 Дууг асаах</button>
  <div id="menu"><div class="menu-inner">
    <button class="btn" id="btnExercise">Дасгал</button>
    <button class="btn" id="btnRestart">Интро дахин</button>
  </div></div>
  <div id="hint">Байршуулахын тулд дэлгэцэнд нэг удаа хүр</div>

  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>
</body>
</html>
