<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª (Placement + Smart Contrast)</title>
  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20; --z-place:7 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    /* Debug */
    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);
           padding:6px 8px;border-radius:6px;font:12px/1.25 monospace;white-space:pre-wrap;max-width:92vw}

    /* Tap-to-start */
    #tapToStart{position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:var(--z-ui)}
    .btn{padding:14px 16px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:800;box-shadow:0 8px 28px rgba(0,0,0,.25)}

    /* Unmute */
    #btnUnmute{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    /* ===== INTRO BUTTONS (menu style) ===== */
    #overlayIntroBtns{ position:fixed; inset:0; z-index:var(--z-ui); pointer-events:none; }
    .introbtn{
      position:absolute; transform:translate(-50%,-50%);
      display:flex; align-items:center; gap:12px; padding:12px 14px;
      border-radius:14px; background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.20);
      color:#fff; font-weight:800; letter-spacing:.2px; font-size:14px;
      box-shadow:0 12px 36px rgba(0,0,0,.45);
      white-space:nowrap; opacity:0;
      transition:opacity .25s ease, transform .25s ease, left .25s ease, top .25s ease;
      user-select:none; pointer-events:none;
      /* smart contrast helpers */
      -webkit-text-stroke: .6px rgba(0,0,0,.8);
      text-shadow: 0 1px 2px rgba(0,0,0,.85), 0 0 1px rgba(255,255,255,.4);
      backdrop-filter: blur(4px);
    }
    .introbtn.show{ opacity:1; }
    .introbtn.mini{ transform:translate(-50%,-50%) scale(.88) }

    /* ===== PLACEMENT UI ===== */
    #placeUI{
      position:fixed; inset:0; display:none; z-index:var(--z-place);
      align-items:center; justify-content:center; pointer-events:none;
    }
    .reticle{
      width:74px;height:74px;border-radius:50%;
      box-shadow:0 0 0 2px rgba(255,255,255,.9) inset, 0 0 0 6px rgba(0,0,0,.35) inset, 0 0 20px rgba(0,0,0,.8);
      animation:pulse 1.4s ease-in-out infinite; pointer-events:none;
    }
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.04)}100%{transform:scale(1)}}
    .placeControls{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%);
      display:flex; gap:10px; z-index:var(--z-place); pointer-events:auto;
    }
    .pill{padding:12px 14px;border-radius:999px;background:rgba(0,0,0,.5);color:#fff;border:1px solid rgba(255,255,255,.25);font-weight:800}
    .hint{
      position:fixed; left:50%; top:18px; transform:translateX(-50%);
      color:#fff; font-weight:700; padding:8px 12px; border-radius:12px;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.25);
      text-shadow:0 1px 2px rgba(0,0,0,.8);
    }

    /* ===== MENU ===== */
    #menu{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:var(--z-menu); background:rgba(0,0,0,.28); backdrop-filter:blur(6px); animation:fadeIn .25s ease forwards;
    }
    .menu-panel{
      width:min(520px,92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      border-radius:20px; padding:20px 18px; box-shadow:0 20px 60px rgba(0,0,0,.35);
      transform:scale(.96); opacity:0; animation:popIn .28s .1s ease forwards;
    }
    .menu-title{
      margin:0 0 10px 0; text-align:center; font-weight:900; letter-spacing:.3px; font-size:22px;
      color:#fff;
    }
    .menu-sub{
      margin:0 0 18px 0; text-align:center; font-size:13px; opacity:.90;
      color:#dfe8ff;
    }
    .menu-grid{display:grid; gap:12px}
    .card{
      display:flex; align-items:center; gap:12px; padding:14px 16px; border-radius:14px; cursor:pointer;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      color:#fff; user-select:none; transform:translateY(12px); opacity:0; animation:slideUp .35s ease forwards;
    }
    .card:nth-child(1){ animation-delay:.18s }
    .card:nth-child(2){ animation-delay:.28s }
    .card:nth-child(3){ animation-delay:.38s }
    .card:hover{ transform:translateY(0) scale(1.01); background:rgba(255,255,255,.12) }
    .card .icon{width:36px;height:36px;border-radius:12px;background:rgba(255,255,255,.15);display:grid;place-items:center;font-size:18px}
    .card .ttl{font-weight:900}

    .row{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .ghost{background:transparent;border:1px dashed rgba(255,255,255,.25);color:#fff}

    /* Smart contrast classes */
    .smartText{
      -webkit-text-stroke: .7px rgba(0,0,0,.9);
      text-shadow: 0 2px 6px rgba(0,0,0,.8), 0 0 1px rgba(255,255,255,.5);
      backdrop-filter: blur(2px);
    }
    .smartBlend{ mix-blend-mode:difference; }

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{to{opacity:1; transform:scale(1)}}
    @keyframes slideUp{to{opacity:1; transform:translateY(0)}}
  </style>

  <!-- Libs -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>
  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister())); }
    window.__depsReady = new Promise(res => addEventListener('load', () => { res({ THREE: window.THREE, ZapparThree: window.ZapparThree }); }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: boot‚Ä¶</div>

  <!-- Tap fallback -->
  <div id="tapToStart"><button class="btn">‚ñ∂ –≠—Ö–ª“Ø“Ø–ª—ç—Ö (–¥—É—É –Ω—ç—ç—Ö)</button></div>
  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>

  <!-- INTRO BUTTONS (sticky) -->
  <div id="overlayIntroBtns">
    <div id="ibExercise"  class="introbtn smartText">üèÉ –î–ê–°–ì–ê–õ</div>
    <div id="ibGrowth"    class="introbtn smartText">üå± –•”®–ì–ñ–ò–õ</div>
    <div id="ibKnowledge" class="introbtn smartText">üìò –•–ò–ß–≠–≠–õ</div>
  </div>

  <!-- PLACEMENT UI -->
  <div id="placeUI">
    <div class="reticle"></div>
  </div>
  <div class="placeControls" id="placeBtns" style="display:none">
    <button id="btnPlace" class="btn">üìç Place</button>
    <button id="btnCancelPlace" class="pill">Cancel</button>
  </div>
  <div id="placeHint" class="hint" style="display:none">–¢”©—Ö”©”©—Ä”©–º–∂”©”© —á–∏–≥–ª“Ø“Ø–ª—ç—ç–¥, —Ö–æ—ë—Ä —Ö—É—Ä—É—É–≥–∞–∞—Ä –∑–∞–π–≥ ”©”©—Ä—á–ª”©”©–¥ ‚ÄúPlace‚Äù –¥–∞—Ä–Ω–∞</div>
  <button id="btnReposition" class="pill" style="position:fixed;right:12px;top:12px;display:none;z-index:var(--z-ui)">‚Üî Reposition</button>

  <!-- Animated Menu -->
  <div id="menu">
    <div class="menu-panel">
      <h2 class="menu-title smartText smartBlend">AR –ú–µ–Ω—é</h2>
      <p class="menu-sub smartText">–¢—É—Ä—à–ª–∞–≥–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É</p>
      <div class="menu-grid">
        <div class="card" id="mExercise">
          <div class="icon">üèÉ</div>
          <div>
            <div class="ttl smartText">–î–∞—Å–≥–∞–ª</div>
            <div style="opacity:.85;font-size:12px" class="smartText">–®—É—É–¥ —Ç–æ–≥–ª—É—É–ª–∞—Ö</div>
          </div>
        </div>
        <div class="card" id="mGrowth">
          <div class="icon">üå±</div>
          <div>
            <div class="ttl smartText">–•—É–≤—å —Ö“Ø–Ω–∏–π —Ö”©–≥–∂–∏–ª</div>
            <div style="opacity:.85;font-size:12px" class="smartText">–¢—É–Ω —É–¥–∞—Ö–≥“Ø–π</div>
          </div>
        </div>
        <div class="card" id="mKnowledge">
          <div class="icon">üìò</div>
          <div>
            <div class="ttl smartText">–•–∏—á—ç—ç–ª</div>
            <div style="opacity:.85;font-size:12px" class="smartText">–¢—É–Ω —É–¥–∞—Ö–≥“Ø–π</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden videos -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

<script>
/* ===== CONFIG ===== */
const INTRO_WEBM_URL     = "https://ariukcs1a.github.io/video/Video_01_alpha_audio.webm";
const INTRO_MP4_URL      = ""; // iOS fallback MP4 (H.264/AAC) —Ö“Ø—Å–≤—ç–ª —ç–Ω–¥
const EXERCISE_WEBM_URL  = "https://ariukcs1a.github.io/video/Video%2002_clean_100MB.webm";
const EXERCISE_MP4_URL   = ""; // iOS fallback MP4

/* –í–∏–¥–µ–æ 90¬∞/180¬∞ —ç—Ä–≥—ç–≤—ç–ª: 0, Math.PI/2, Math.PI */
const VIDEO_ROT_Z = 0;

/* –ò–Ω—Ç—Ä–æ —Ç–æ–≤—á–Ω—É—É–¥—ã–Ω timeline (u,v –Ω—å -1..+1) */
const BTN_TIMELINE = [
  { id:'ex', t:[20.5, 22.8], u:-0.18, v: 0.18, show:true },
  { id:'gr', t:[30.5, 33.2], u: 0.26, v: 0.16, show:true },
  { id:'kn', t:[35.0, 37.0], u:-0.08, v: 0.02, show:true },
];
/* Sticky –æ—Ñ—Ñ—Å–µ—Ç */
const BTN_OFFSETS_LOCKED = {
  ex: { dx: -5,  dy: -28 },
  kn: { dx: -5,  dy:  28 },
  gr: { dx:  15, dy:   0 },
};

const dbg=(m)=>document.getElementById('debug').textContent='DEBUG: '+m;
const vIntro = document.getElementById('vidIntro');
const vEx    = document.getElementById('vidExercise');
const btnUnmute=document.getElementById('btnUnmute');
const tapLay = document.getElementById('tapToStart');
const menu   = document.getElementById('menu');
const overlayIntro = document.getElementById('overlayIntroBtns');

const placeUI    = document.getElementById('placeUI');
const placeBtns  = document.getElementById('placeBtns');
const placeHint  = document.getElementById('placeHint');
const btnPlace   = document.getElementById('btnPlace');
const btnCancelP = document.getElementById('btnCancelPlace');
const btnRePos   = document.getElementById('btnReposition');

/* Intro buttons map */
const introBtnEls = {
  ex: document.getElementById('ibExercise'),
  gr: document.getElementById('ibGrowth'),
  kn: document.getElementById('ibKnowledge'),
};
/* Sticky —Ç”©–ª”©–≤ */
const introBtnState = {
  ex:{shown:false, locked:false, x:0, y:0},
  gr:{shown:false, locked:false, x:0, y:0},
  kn:{shown:false, locked:false, x:0, y:0},
};

/* ===== AR Engine ===== */
let THREE, ZT, renderer, camera, scene, tracker, anchor, plane;
let scaleFactor=1.35;
const MIN_S=0.6, MAX_S=3;
let texIntro, texEx, currentVideo, baseH=0.9;
let anchorSet = false;
/* üëá –≠–î –ù–¨ –ó”®–í–•”®–ù –ù–≠–ì –£–î–ê–ê –ó–ê–†–õ–ê–ì–î–ê–ù–ê */
let lastUIT = -1;
let showIntroBtns = false;

/* Placement state */
let placing = false;
let placeDist = 1.5; // –º. –ö–∞–º–µ—Ä—ã–Ω ”©–º–Ω”©—Ö –∑–∞–π

function setSources(el, webm, mp4=""){
  el.crossOrigin="anonymous";
  el.setAttribute('playsinline','');
  el.setAttribute='preload';
  el.innerHTML="";
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  if (isIOS && mp4) {
    const s2=document.createElement('source'); s2.src=mp4; s2.type='video/mp4'; el.appendChild(s2);
    if (webm){ const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1); }
  } else {
    if (webm){ const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1); }
    if (mp4){  const s2=document.createElement('source'); s2.src=mp4;  s2.type='video/mp4'; el.appendChild(s2); }
  }
  el.load();
}

function applyScale(){
  if(!plane) return;
  plane.scale.set(scaleFactor, scaleFactor, 1);
  plane.position.set(0,0,0);
}
function fitPlaneToVideo(el){
  const w=el.videoWidth||1280, h=el.videoHeight||720;
  baseH=0.9;
  const W=baseH*(w/h);
  plane.geometry?.dispose?.();
  plane.geometry=new THREE.PlaneGeometry(W, baseH);
  applyScale();
}
function faceCameraNoRotate(){
  plane.quaternion.copy(camera.quaternion);
  plane.rotation.z = VIDEO_ROT_Z;
}
async function ensureCamera(){
  const ok=await ZT.permissionRequest();
  if(!ok){ZT.permissionDeniedUI(); throw new Error('camera permission denied');}
  try{camera.start();}catch{}
  dbg('camera started');
}
function videoTexture(el){
  const t=new THREE.VideoTexture(el);
  t.colorSpace=THREE.SRGBColorSpace;
  t.flipY=true;
  return t;
}

/* ===== Gestures ===== */
function hookGestures(){
  addEventListener('touchstart', ()=>{}, {passive:true});
  addEventListener('touchmove', e=>{
    if (e.touches.length===2){
      const d=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
      const k=d(e.touches[0],e.touches[1]);
      const prev=Number(plane.dataset_prevDist||k);
      if (prev>0){
        const ratio = k/prev;
        if (placing){
          // Placement: —Ö–æ—ë—Ä —Ö—É—Ä—É—É–≥–∞–∞—Ä anchor —Ö“Ø—Ä—Ç—ç–ª—Ö –∑–∞–π
          placeDist = Math.min(5, Math.max(0.35, placeDist / ratio));
        }else{
          // –≠–Ω–≥–∏–π–Ω: –º–∞—Å—à—Ç–∞–±
          scaleFactor = Math.min(MAX_S, Math.max(MIN_S, scaleFactor*ratio));
          applyScale();
        }
      }
      plane.dataset_prevDist = k;
    }
  },{passive:true});
  addEventListener('touchend', ()=>{ plane.dataset_prevDist=""; }, {passive:true});

  addEventListener('wheel', e=>{
    if (placing){
      placeDist = Math.min(5, Math.max(0.35, placeDist * (e.deltaY>0?1.06:0.94)));
    }else{
      scaleFactor=Math.min(MAX_S,Math.max(MIN_S,scaleFactor*(e.deltaY>0?0.95:1.05)));
      applyScale();
    }
  }, {passive:true});
}

/* 3D ‚Üí 2D */
function worldToScreen(v){
  if (!renderer || !camera) return {x:-9999, y:-9999};
  const rect = renderer.domElement.getBoundingClientRect();
  const p = v.clone().project(camera);
  const x = (p.x * 0.5 + 0.5) * rect.width  + rect.left;
  const y = (-p.y* 0.5 + 0.5) * rect.height + rect.top;
  return {x,y};
}
function localOnPlane(u,v){
  if (!plane || !plane.geometry || !plane.geometry.parameters) return new THREE.Vector3(0,0,0);
  const w = plane.geometry.parameters.width;
  const h = plane.geometry.parameters.height;
  const pt = new THREE.Vector3(u*w*0.5, v*h*0.5, 0);
  return plane.localToWorld(pt);
}

/* –ò–Ω—Ç—Ä–æ —Ç–æ–≤—á–Ω—É—É–¥ (sticky + offsets) */
function updateIntroButtons(){
  if (!showIntroBtns) return;
  const t = vIntro.currentTime || 0;
  if (Math.abs(t - lastUIT) < 0.033) return;
  lastUIT = t;

  const segOf = (id) => {
    const f = BTN_TIMELINE.filter(s => s.id === id && t >= s.t[0] && t < s.t[1]);
    return f.length ? f[f.length - 1] : null;
  };
  const proc = (key, el) => {
    const seg = segOf(key);
    const st  = introBtnState[key];

    if (seg && seg.show){
      const w = worldToScreen(localOnPlane(seg.u, seg.v));
      el.style.left = w.x+'px';
      el.style.top  = w.y+'px';
      el.classList.add('show');
      st.shown = true; st.locked = false; st.x = w.x; st.y = w.y;
    } else if (st.shown) {
      if (!st.locked){
        st.locked = true;
        const off = BTN_OFFSETS_LOCKED[key] || {dx:0,dy:0};
        el.style.left = (st.x + off.dx) + 'px';
        el.style.top  = (st.y + off.dy) + 'px';
      }
      el.classList.add('show');
    } else {
      el.classList.remove('show');
    }
  };
  proc('ex', introBtnEls.ex);
  proc('gr', introBtnEls.gr);
  proc('kn', introBtnEls.kn);
}

/* –ú–µ–Ω—é —Ö–∞—Ä—É—É–ª–∞—Ö */
function showMenuOverlay(){
  menu.style.display='flex';
  menu.style.opacity='1';
  menu.style.pointerEvents='auto';
}

/* ===== Placement helpers ===== */
function enterPlacement(){
  placing = true;
  anchorSet = false; // frame —Ç—É—Ç–∞–º–¥ anchor-–≥ –∫–∞–º–µ—Ä—Ç–∞–π —Ö–∞—Ä—å—Ü–∞–Ω–≥—É–π –±–∞–π—Ä–ª—É—É–ª–Ω–∞
  placeUI.style.display = 'flex';
  placeBtns.style.display = 'flex';
  placeHint.style.display = 'block';
  btnRePos.style.display = 'none';
}
function exitPlacement(commit=true){
  placeUI.style.display = 'none';
  placeBtns.style.display = 'none';
  placeHint.style.display = 'none';
  placing = false;
  if (commit){
    // commit —Ö–∏–π—Å–Ω–∏–π –¥–∞—Ä–∞–∞ anchor-–≥ —Ç–æ–≥—Ç–≤–æ—Ä—Ç–æ–π “Ø–ª–¥—ç—ç–Ω—ç
    anchorSet = true;
    btnRePos.style.display = 'block';
  }else{
    // cancel
    anchorSet = true;
    btnRePos.style.display = 'block';
  }
}

/* Bootstrap */
(async function bootstrap(){
  const libs = await window.__depsReady;
  THREE = libs.THREE; ZT = libs.ZapparThree;
  if (!THREE||!ZT){ dbg('libs not loaded'); return; }
  if (ZT.browserIncompatible()){ ZT.browserIncompatibleUI(); dbg('browser incompatible'); return; }

  renderer=new THREE.WebGLRenderer({antialias:true,alpha:false,powerPreference:'high-performance'});
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
  renderer.setSize(innerWidth,innerHeight);
  renderer.domElement.classList.add('webgl'); document.body.appendChild(renderer.domElement);
  addEventListener('resize', ()=>{
    renderer.setSize(innerWidth,innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
  });
  ZT.glContextSet(renderer.getContext());

  camera=new ZT.Camera({userFacing:false});
  scene=new THREE.Scene(); scene.background=camera.backgroundTexture;

  tracker=new ZT.InstantWorldTracker();
  anchor=new ZT.InstantWorldAnchorGroup(camera,tracker); scene.add(anchor);

  plane=new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({transparent:true, side:THREE.DoubleSide}));
  anchor.add(plane);

  hookGestures();

  renderer.setAnimationLoop(()=>{
    // Placement –≥–æ—Ä–∏–º: anchor-—ã–≥ –∫–∞–º–µ—Ä—ã–Ω ”©–º–Ω”© placeDist –∑–∞–π–¥ –±“Ø—Ä –∫–∞–¥—Ä –¥—ç—ç—Ä —à–∏–Ω—ç—á–∏–ª–Ω—ç
    if (placing){
      tracker.setAnchorPoseFromCameraOffset(0, 0, -placeDist);
    } else if (!anchorSet){
      // –≠–Ω–≥–∏–π–Ω —ç—Ö–ª—ç–ª—Ç/–∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–ª–∏—Ö “Ø–µ–¥ –≥–∞–Ω—Ü—Ö–∞–Ω —É–¥–∞–∞ –∞–Ω—Ö–Ω—ã –±–∞–π—Ä–ª–∞–ª
      tracker.setAnchorPoseFromCameraOffset(0, 0, -placeDist);
      anchorSet = true;
    }

    faceCameraNoRotate(); // billboard

    camera.updateFrame(renderer);
    renderer.render(scene,camera);

    if (currentVideo===vIntro) updateIntroButtons();
  });

  document.addEventListener('visibilitychange', ()=>{ try{ document.hidden?camera.pause():camera.start(); }catch{} });

  // Start intro
  try{ await startIntro_Auto(); }
  catch(e){
    tapLay.style.display='grid'; dbg('need user gesture to start with sound');
  }

  tapLay.addEventListener('pointerdown', async ()=>{
    tapLay.style.display='none';
    try{ await startIntro_Auto(true); }catch(e){ dbg('after tap failed: '+(e?.message||e)); }
  });

  // –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª
  document.getElementById('mExercise').addEventListener('click', async ()=>{ await startExerciseDirect(); });

  // Restart intro
  document.getElementById('btnRestart').addEventListener('click', async ()=>{
    closeMenu();
    try{ currentVideo && currentVideo.pause(); }catch{}
    Object.values(introBtnState).forEach(s => { s.shown=false; s.locked=false; });
    ['ex','gr','kn'].forEach(id=>introBtnEls[id].classList.remove('mini','show'));
    await startIntro_Auto(true);
  });

  // Placement buttons
  btnPlace.addEventListener('click', ()=> exitPlacement(true));
  btnCancelP.addEventListener('click', ()=> exitPlacement(false));
  btnRePos.addEventListener('click', ()=> enterPlacement());
})();

/* Intro flow */
async function startIntro_Auto(fromTap=false){
  overlayIntro.style.display = 'block';
  showIntroBtns = true;

  await ensureCamera();

  // –≠—Ö–ª—ç—Ö –±–æ–ª–≥–æ–Ω–¥ placement –≥–æ—Ä–∏–º
  placeDist = 1.5;
  enterPlacement();

  setSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
  setSources(vEx,    EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

  texIntro=texIntro||videoTexture(vIntro);
  texEx   =texEx   ||videoTexture(vEx);

  currentVideo=vIntro;
  plane.material.map=texIntro;

  scaleFactor=1.35; applyScale();

  if (vIntro.readyState>=1) fitPlaneToVideo(vIntro);
  else await new Promise(r=>vIntro.addEventListener('loadedmetadata', ()=>{fitPlaneToVideo(vIntro); r();},{once:true}));

  try{
    vIntro.muted=false; await vIntro.play(); btnUnmute.style.display='none';
  }catch{
    try{ vIntro.muted=true; await vIntro.play(); btnUnmute.style.display='inline-block'; }
    catch(e){ if (!fromTap){ tapLay.style.display='grid'; throw new Error('autoplay prevented'); } }
  }

  dbg('intro playing');

  vIntro.onended=()=>{
    ['ex','gr','kn'].forEach(id=>introBtnEls[id].classList.add('mini'));
    showMenuOverlay();
    dbg('intro ended ‚Üí menu shown; intro buttons stay (mini).');
  };
}

/* Menu */
function closeMenu(){ menu.style.display='none'; }

/* Exercise ‚Äî —à—É—É–¥ —Ç–æ–≥–ª—É—É–ª–∞—Ö (–∏–Ω—Ç—Ä–æ —Ç–æ–≤—á–Ω—É—É–¥—ã–≥ –±“Ø—Ä—ç–Ω –Ω—É—É—Ö) */
async function startExerciseDirect(){
  closeMenu();

  overlayIntro.style.display = 'none';
  showIntroBtns = false;
  ['ex','gr','kn'].forEach(id => introBtnEls[id].classList.remove('show','mini'));

  try{ await ensureCamera(); }catch{}
  if (currentVideo) try { currentVideo.pause(); } catch {}

  // –•—ç—Ä—ç–≤ –¥–∞—Å–≥–∞–ª —ç—Ö–ª—ç—Ö–∏–π–Ω ”©–º–Ω”© –±–∞–π—Ä—à–∏–ª –¥–∞—Ö–∏–Ω —Å–æ–Ω–≥—É—É–ª–∞—Ö –±–æ–ª:
  // enterPlacement();

  setSources(vEx, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);
  currentVideo=vEx;

  if (vEx.readyState>=1) fitPlaneToVideo(vEx);
  else await new Promise(r=>vEx.addEventListener('loadedmetadata', ()=>{fitPlaneToVideo(vEx); r();},{once:true}));

  plane.material.map = texEx || (texEx = videoTexture(vEx));

  scaleFactor=1.35; applyScale();
  vEx.currentTime=0;

  try{
    vEx.muted=false; await vEx.play(); btnUnmute.style.display='none';
  }catch{
    try{ vEx.muted=true; await vEx.play(); btnUnmute.style.display='inline-block'; }catch{}
  }

  btnRePos.style.display = 'block'; // –î–∞—Å–≥–∞–ª—ã–Ω “Ø–µ—ç—Ä —á –¥–∞—Ö–∏–Ω –±–∞–π—Ä–ª—É—É–ª–∂ –±–æ–ª–Ω–æ
  dbg('exercise playing (AR).');
}

/* Unmute */
btnUnmute.addEventListener('click', async ()=>{
  try{
    currentVideo.muted=false;
    await currentVideo.play();
    btnUnmute.style.display='none';
  }catch(e){ dbg('unmute failed'); }
});
</script>
</body>
</html>
