<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR â€” Intro â†’ Menu â†’ Exercise</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform 0.2s ease}
    .btn:hover{transform:scale(1.05)}
    .btn:active{transform:scale(0.95)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,0.8)}
    .menu-inner{display:flex;flex-direction:column;gap:16px;padding:20px;border-radius:20px;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px)}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.4 monospace;white-space:pre-wrap;max-width:90vw;
           border:1px solid rgba(0,255,0,0.3)}
    
    #instructions{position:fixed;bottom:20px;left:20px;right:20px;z-index:var(--z-ui);
                  color:#fff;text-align:center;background:rgba(0,0,0,0.6);
                  padding:12px;border-radius:12px;font-size:14px;display:none}
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // Clear any existing service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    
    // Wait for dependencies to load
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: Initializing...</div>

  <!-- UI Elements -->
  <div id="startLayer">
    <div style="text-align:center;">
      <h1 style="color:#fff;margin-bottom:30px;font-size:24px;">WebAR Experience</h1>
      <button id="btnStart" class="btn">â–¶ START EXPERIENCE</button>
    </div>
  </div>
  
  <button id="btnUnmute" class="btn">ðŸ”Š Enable Audio</button>
  
  <div id="menu">
    <div class="menu-inner">
      <h2 style="color:#fff;margin:0 0 10px 0;text-align:center;">Select Experience</h2>
      <button class="btn" id="btnExercise">Start Exercise</button>
      <button class="btn" id="btnRestart">Restart Intro</button>
    </div>
  </div>

  <div id="instructions">Tap anywhere to place the AR content in your space</div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

  <script>
    /********** Configuration **********/
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = "";
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = "";

    // Debug logger
    const dbg = (message) => {
      console.log('DEBUG:', message);
      document.getElementById('debug').textContent = 'DEBUG: ' + message;
    };

    // DOM elements
    const vIntro     = document.getElementById('vidIntro');
    const vExercise  = document.getElementById('vidExercise');
    const startLayer = document.getElementById('startLayer');
    const btnStart   = document.getElementById('btnStart');
    const btnUnmute  = document.getElementById('btnUnmute');
    const menu       = document.getElementById('menu');
    const instructions = document.getElementById('instructions');

    // Set video sources with proper codec support
    function setupVideoSources(videoElement, webmUrl, mp4Url = "") {
      videoElement.innerHTML = "";
      
      if (webmUrl) {
        const webmSource = document.createElement('source');
        webmSource.src = webmUrl;
        webmSource.type = 'video/webm; codecs="vp8,opus"';
        videoElement.appendChild(webmSource);
      }
      
      if (mp4Url) {
        const mp4Source = document.createElement('source');
        mp4Source.src = mp4Url;
        mp4Source.type = 'video/mp4';
        videoElement.appendChild(mp4Source);
      }
      
      videoElement.load();
    }

    /********** AR Engine **********/
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let hasPlacedContent = false;
    let introTexture, exerciseTexture, currentVideo;

    // Request camera permissions
    async function requestCameraAccess() {
      try {
        const permitted = await ZapparThree.permissionRequest();
        if (!permitted) {
          ZapparThree.permissionDeniedUI();
          throw new Error('Camera permission denied');
        }
        camera?.start();
        dbg('Camera access granted and started');
        return true;
      } catch (error) {
        dbg('Camera permission failed: ' + error.message);
        throw error;
      }
    }

    // Create video texture
    function createVideoTexture(videoElement) {
      const texture = new THREE.VideoTexture(videoElement);
      texture.colorSpace = THREE.SRGBColorSpace;
      texture.flipY = false;
      return texture;
    }

    // Fit plane to video aspect ratio and position it upright
    function adjustPlaneToVideo(videoElement) {
      const width = videoElement.videoWidth || 1280;
      const height = videoElement.videoHeight || 720;
      const displayHeight = 0.9; // 0.9 meters tall
      const displayWidth = displayHeight * (width / height);
      
      // Update geometry
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(displayWidth, displayHeight);
      
      // Position so bottom edge touches ground (y=0)
      plane.position.set(0, displayHeight / 2, 0);
      
      dbg(`Video dimensions: ${width}x${height}, AR plane: ${displayWidth.toFixed(2)}x${displayHeight}`);
    }

    // Make plane face camera (billboard effect) but keep it upright
    const tempEuler = new THREE.Euler(0, 0, 0, 'YXZ');
    function makePlaneUpright() {
      // Extract only the yaw rotation from camera
      tempEuler.setFromQuaternion(camera.quaternion, 'YXZ');
      tempEuler.x = 0; // Remove pitch (keep upright)
      tempEuler.z = 0; // Remove roll (keep upright)
      plane.quaternion.setFromEuler(tempEuler);
    }

    // Initialize AR system
    async function initializeAR() {
      try {
        // Wait for dependencies
        ({ THREE, ZapparThree } = await window.__depsReady);
        
        if (!THREE || !ZapparThree) {
          throw new Error('Failed to load THREE.js or ZapparThree dependencies');
        }

        // Check browser compatibility
        if (ZapparThree.browserIncompatible()) {
          ZapparThree.browserIncompatibleUI();
          return;
        }

        // Setup WebGL renderer
        renderer = new THREE.WebGLRenderer({ 
          antialias: true, 
          alpha: false, 
          powerPreference: 'high-performance' 
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.classList.add('webgl');
        document.body.appendChild(renderer.domElement);

        // Handle window resize
        window.addEventListener('resize', () => {
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize Zappar GL context
        ZapparThree.glContextSet(renderer.getContext());

        // Setup camera and scene
        camera = new ZapparThree.Camera({ userFacing: false }); // Use back camera
        scene = new THREE.Scene();
        scene.background = camera.backgroundTexture;

        // Setup instant world tracking
        tracker = new ZapparThree.InstantWorldTracker();
        anchor = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
        scene.add(anchor);

        // Create display plane
        plane = new THREE.Mesh(
          new THREE.PlaneGeometry(1, 1),
          new THREE.MeshBasicMaterial({ 
            transparent: true, 
            side: THREE.DoubleSide 
          })
        );
        anchor.add(plane);

        // Start render loop
        renderer.setAnimationLoop(() => {
          if (!hasPlacedContent) {
            // Before placement, position content 2 meters in front
            tracker.setAnchorPoseFromCameraOffset(0, 0, -2);
          }
          
          // Keep plane upright and facing camera
          makePlaneUpright();
          
          // Update and render
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        });

        // Handle app visibility changes
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            try { camera.start(); } catch (e) { console.warn('Failed to restart camera:', e); }
          } else {
            try { camera.pause(); } catch (e) { console.warn('Failed to pause camera:', e); }
          }
        });

        dbg('AR system initialized successfully');
        
      } catch (error) {
        console.error('AR initialization failed:', error);
        dbg('AR initialization failed: ' + error.message);
        throw error;
      }
    }

    // Play video with audio handling
    async function playVideoWithAudio(videoElement) {
      try {
        videoElement.muted = false;
        await videoElement.play();
        btnUnmute.style.display = 'none';
        dbg('Video playing with audio');
      } catch (error) {
        // Fallback to muted playback
        videoElement.muted = true;
        try {
          await videoElement.play();
          btnUnmute.style.display = 'inline-block';
          dbg('Video playing muted - click unmute button');
        } catch (playError) {
          dbg('Failed to play video: ' + playError.message);
        }
      }
    }

    // Start AR experience
    btnStart.addEventListener('click', async () => {
      try {
        dbg('Starting AR experience...');
        
        // Request camera access
        await requestCameraAccess();

        // Setup video sources
        setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
        setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

        // Create textures
        introTexture = introTexture || createVideoTexture(vIntro);
        exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

        // Start with intro video
        currentVideo = vIntro;
        plane.material.map = introTexture;
        hasPlacedContent = false;

        // Setup video dimensions
        if (vIntro.readyState >= 1) {
          adjustPlaneToVideo(vIntro);
        } else {
          vIntro.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vIntro), { once: true });
        }

        // Play intro video
        await playVideoWithAudio(vIntro);

        // Setup placement handler
        const handlePlacement = () => {
          hasPlacedContent = true;
          instructions.style.display = 'none';
          window.removeEventListener('pointerdown', handlePlacement);
          dbg('AR content placed in space');
        };
        
        window.addEventListener('pointerdown', handlePlacement, { once: true, passive: true });

        // Show instructions and hide start screen
        instructions.style.display = 'block';
        startLayer.style.display = 'none';
        
        dbg('Intro video ready - tap to place in AR space');

        // Handle intro video end
        vIntro.onended = () => {
          menu.style.display = 'flex';
          instructions.style.display = 'none';
          dbg('Intro completed - showing menu');
        };

      } catch (error) {
        console.error('Failed to start AR experience:', error);
        dbg('Failed to start: ' + error.message);
        alert('Failed to start AR experience. Please ensure you have granted camera permissions and are using a supported browser.');
      }
    });

    // Enable audio button
    btnUnmute.addEventListener('click', async () => {
      if (currentVideo) {
        try {
          currentVideo.muted = false;
          await currentVideo.play();
          btnUnmute.style.display = 'none';
          dbg('Audio enabled');
        } catch (error) {
          dbg('Failed to enable audio: ' + error.message);
        }
      }
    });

    // Exercise button
    document.getElementById('btnExercise').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Starting exercise...');

        // Ensure camera is active
        try { await requestCameraAccess(); } catch (e) { console.warn('Camera already active or failed to restart'); }

        // Stop current video
        if (currentVideo) {
          currentVideo.pause();
        }

        // Switch to exercise video
        currentVideo = vExercise;
        plane.material.map = exerciseTexture;
        hasPlacedContent = false;

        // Setup exercise video dimensions
        if (vExercise.readyState >= 1) {
          adjustPlaneToVideo(vExercise);
        } else {
          vExercise.addEventListener('loadedmetadata', () => adjustPlaneToVideo(vExercise), { once: true });
        }

        // Setup placement and play handler
        const startExercise = async () => {
          hasPlacedContent = true;
          vExercise.currentTime = 0; // Restart from beginning
          await playVideoWithAudio(vExercise);
          instructions.style.display = 'none';
          window.removeEventListener('pointerdown', startExercise);
          dbg('Exercise placed and playing');
        };

        window.addEventListener('pointerdown', startExercise, { once: true, passive: true });
        instructions.style.display = 'block';
        
        dbg('Exercise ready - tap to place and start');

      } catch (error) {
        console.error('Failed to start exercise:', error);
        dbg('Failed to start exercise: ' + error.message);
      }
    });

    // Restart intro button
    document.getElementById('btnRestart').addEventListener('click', async () => {
      try {
        menu.style.display = 'none';
        dbg('Restarting intro...');

        // Stop current video
        if (currentVideo) {
          currentVideo.pause();
        }

        // Switch back to intro
        currentVideo = vIntro;
        plane.material.map = introTexture;
        hasPlacedContent = false;

        // Reset and play intro
        vIntro.currentTime = 0;
        await playVideoWithAudio(vIntro);

        // Setup placement handler
        const handlePlacement = () => {
          hasPlacedContent = true;
          instructions.style.display = 'none';
          window.removeEventListener('pointerdown', handlePlacement);
          dbg('Intro content placed');
        };
        
        window.addEventListener('pointerdown', handlePlacement, { once: true, passive: true });
        instructions.style.display = 'block';

        dbg('Intro restarted - tap to place');

      } catch (error) {
        console.error('Failed to restart intro:', error);
        dbg('Failed to restart: ' + error.message);
      }
    });

    // Initialize AR system on page load
    initializeAR().catch(error => {
      console.error('Failed to initialize AR:', error);
      dbg('Initialization failed - check console for details');
    });
  </script>
</body>
</html>