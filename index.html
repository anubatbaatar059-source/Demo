<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª (Zappar, Fixed)</title>
  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}
    #tapToStart{position:fixed;inset:0;display:none;place-items:center;background:#000;z-index:var(--z-ui)}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #btnUnmute{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:var(--z-ui);display:none}
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,.6)}
    .menu-inner{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:16px;background:rgba(255,255,255,.08);backdrop-filter:blur(8px)}
    #hint{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);color:#fff;background:rgba(0,0,0,.55);padding:10px 14px;border-radius:12px;display:none}
    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:6px;font:12px/1.25 monospace;white-space:pre-wrap;max-width:92vw}
  </style>

  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: boot‚Ä¶</div>

  <div id="tapToStart"><button class="btn">‚ñ∂ –ö–∞–º–µ—Ä –Ω—ç—ç—Ö</button></div>

  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>
  <div id="menu"><div class="menu-inner">
    <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª —ç—Ö–ª“Ø“Ø–ª—ç—Ö</button>
    <button class="btn" id="btnRestart">–ò–Ω—Ç—Ä–æ –¥–∞—Ö–∏–Ω</button>
    <button class="btn" id="btnCloseMenu">‚úï –•–∞–∞—Ö</button>
  </div></div>
  <div id="hint">–î—ç–ª–≥—ç—Ü—ç–Ω–¥ —Ö“Ø—Ä—á –±–∞–π—Ä—à—É—É–ª (drag = —ç—Ä–≥“Ø“Ø–ª—ç—Ö, pinch = —Ç–æ–º/–∂–∏–∂–∏–≥)</div>

  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

<script>
/* ======= CONFIG ======= */
const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
const INTRO_MP4_URL      = "";
const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
const EXERCISE_MP4_URL   = "";

/* –•—ç—Ä—ç–≤ —Ç–∞–Ω–∞–π –±–∏—á–ª—ç–≥ 90¬∞ —ç—Ä–≥—ç—á–∏—Ö–¥—ç–≥ –±–æ–ª –¥–æ–æ—Ä—Ö—ã–≥ Math.PI/2 –±–æ–ª–≥–æ–æ—Ä–æ–π.
   –•—ç—Ä—ç–≤ –±“Ø—Ä—ç–Ω —Ç–æ–Ω–≥–æ—Ä—á–∏—Ö–¥–æ–≥ (—Ç–æ–ª–≥–æ–π–≥–æ–æ—Ä–æ–æ) –±–æ–ª Math.PI —Ç–∞–≤—å. */
const VIDEO_ROT_Z = 0; // —Ä–∞–¥

const dbg = (m)=>document.getElementById('debug').textContent = 'DEBUG: ' + m;
const vIntro = document.getElementById('vidIntro');
const vEx    = document.getElementById('vidExercise');
const btnUnmute = document.getElementById('btnUnmute');
const menu = document.getElementById('menu');
const hint = document.getElementById('hint');
const tapLay = document.getElementById('tapToStart');

function setSources(el, webm, mp4=""){
  el.crossOrigin = "anonymous";
  el.setAttribute('playsinline','');
  el.innerHTML = "";
  if (webm){ const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1); }
  if (mp4){  const s2=document.createElement('source'); s2.src=mp4;  s2.type='video/mp4'; el.appendChild(s2); }
  el.load();
}

/* ======= AR engine ======= */
let THREE, ZT, renderer, camera, scene, tracker, anchor, plane;
let hasPlaced=false, scaleFactor=1.2, spinSpeed=0.9*Math.PI/180;
const MIN_S=0.3, MAX_S=3;
let texIntro, texEx, currentVideo;
let baseH = 0.9;

function applyScale(){ if(!plane) return; plane.scale.set(scaleFactor,scaleFactor,1); plane.position.y=(baseH*scaleFactor)/2; }
function fitPlaneToVideo(el){
  const w=el.videoWidth||1280, h=el.videoHeight||720;
  baseH=0.9; const W=baseH*(w/h);
  plane.geometry.dispose();
  plane.geometry = new THREE.PlaneGeometry(W, baseH);
  applyScale();
}
function faceCameraYawOnly(){
  const eul = new THREE.Euler().setFromQuaternion(camera.quaternion,'YXZ');
  eul.x=0; eul.z=0;
  plane.quaternion.setFromEuler(eul);
  // –í–∏–¥–µ–æ ”©”©—Ä”©”© –±—É—Ä—É—É —ç—Ä–≥—ç—Ö —Ç–æ—Ö–∏–æ–ª–¥–æ–ª–¥ –º–∞—Ç–µ—Ä–∏–∞–ª –¥—ç—ç—Ä Z —ç—Ä–≥“Ø“Ø–ª—ç–ª—Ç–∏–π–≥ ”©–≥–Ω”©
  plane.rotation.z = VIDEO_ROT_Z;
}
async function ensureCamera(){
  const ok = await ZT.permissionRequest();
  if (!ok) { ZT.permissionDeniedUI(); throw new Error('camera permission denied'); }
  try { camera.start(); } catch {}
  dbg('camera started');
}
function videoTexture(el){
  const t=new THREE.VideoTexture(el);
  t.colorSpace = THREE.SRGBColorSpace;
  /* üîß –£—Ä–¥ –Ω—å flipY=false –±–∞–π—Å–∞–Ω ‚Äî –∏–Ω–≥—ç—Å–Ω—ç—ç—Ä –≤–∏–¥–µ–æ —Ç–æ–ª–≥–æ–π–≥–æ–æ—Ä–æ–æ —Ö–∞—Ä–∂ –±–∞–π–ª–∞–∞.
     –≠–Ω–∏–π–≥ true –±–æ–ª–≥–æ–∂ –í–ï–ë–ú-–∏–π–≥ –∑”©–≤ —á–∏–≥–ª—ç–ª–¥ —Ö–∞—Ä—É—É–ª–Ω–∞. */
  t.flipY = true;
  return t;
}

/* Gestures */
let pinch={active:false,startDist:0,startScale:1,startAngle:0,startYaw:0};
let drag ={active:false,startX:0,startYaw:0};
const dist2=(a,b)=>Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
const angle2=(a,b)=>Math.atan2(b.clientY-a.clientY,b.clientX-a.clientX);
function hookGestures(){
  addEventListener('touchstart', e=>{
    if (!hasPlaced) return;
    if (e.touches.length===2){
      pinch={active:true,startDist:dist2(e.touches[0],e.touches[1]),startScale:scaleFactor,startAngle:angle2(e.touches[0],e.touches[1]),startYaw:plane.rotation.y};
    } else if (e.touches.length===1){
      drag={active:true,startX:e.touches[0].clientX,startYaw:plane.rotation.y};
    }
  },{passive:true});
  addEventListener('touchmove', e=>{
    if (!hasPlaced) return;
    if (pinch.active && e.touches.length===2){
      const k = dist2(e.touches[0], e.touches[1])/(pinch.startDist||1);
      scaleFactor = Math.min(MAX_S, Math.max(MIN_S, pinch.startScale*k));
      const ang = angle2(e.touches[0], e.touches[1]);
      plane.rotation.y = pinch.startYaw + (ang - pinch.startAngle);
      faceCameraYawOnly(); applyScale();
    } else if (drag.active && e.touches.length===1){
      const dx=e.touches[0].clientX - drag.startX;
      plane.rotation.y = drag.startYaw + dx*0.004;
      faceCameraYawOnly();
    }
  },{passive:true});
  addEventListener('touchend', e=>{ if (e.touches.length<2) pinch.active=false; if (e.touches.length===0) drag.active=false; }, {passive:true});
  addEventListener('wheel', e=>{ if (!hasPlaced) return; scaleFactor=Math.min(MAX_S,Math.max(MIN_S,scaleFactor*(e.deltaY>0?0.95:1.05))); applyScale(); }, {passive:true});
  addEventListener('pointerdown', e=>{ if (!hasPlaced) return; drag={active:true,startX:e.clientX,startYaw:plane.rotation.y}; });
  addEventListener('pointermove', e=>{ if (!hasPlaced||!drag.active) return; const dx=e.clientX-drag.startX; plane.rotation.y=drag.startYaw+dx*0.004; faceCameraYawOnly(); });
  addEventListener('pointerup', ()=>{ drag.active=false; });
}

/* Bootstrap */
(async function bootstrap(){
  ({ THREE, ZapparThree: ZT } = await window.__depsReady);
  if (!THREE || !ZT){ dbg('libs not loaded'); return; }
  if (ZT.browserIncompatible()){ ZT.browserIncompatibleUI(); dbg('browser incompatible'); return; }

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
  renderer.setSize(innerWidth, innerHeight);
  renderer.domElement.classList.add('webgl');
  document.body.appendChild(renderer.domElement);
  addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
  ZT.glContextSet(renderer.getContext());

  camera = new ZT.Camera({ userFacing:false });
  scene  = new THREE.Scene();
  scene.background = camera.backgroundTexture;

  tracker = new ZT.InstantWorldTracker();
  anchor  = new ZT.InstantWorldAnchorGroup(camera, tracker);
  scene.add(anchor);

  plane = new THREE.Mesh(
    new THREE.PlaneGeometry(1,1),
    new THREE.MeshBasicMaterial({ transparent:true, side: THREE.DoubleSide })
  );
  anchor.add(plane);

  hookGestures();

  renderer.setAnimationLoop(()=>{
    if (!hasPlaced){
      tracker.setAnchorPoseFromCameraOffset(0,0,-2);
      faceCameraYawOnly();
      plane.rotation.y += spinSpeed;
    }
    camera.updateFrame(renderer);
    renderer.render(scene, camera);
  });

  document.addEventListener('visibilitychange', ()=>{ try{ document.hidden ? camera.pause() : camera.start(); }catch{} });

  try { await startIntroFlow(); }
  catch(e){ tapLay.style.display='grid'; dbg('need user gesture'); }
})();

/* Flows */
async function startIntroFlow(){
  await ensureCamera();

  setSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
  setSources(vEx,    EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

  texIntro = texIntro || videoTexture(vIntro);
  texEx    = texEx    || videoTexture(vEx);

  currentVideo = vIntro;
  plane.material.map = texIntro;
  hasPlaced=false; scaleFactor=1.2; applyScale();

  if (vIntro.readyState>=1) fitPlaneToVideo(vIntro);
  else vIntro.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vIntro), {once:true});

  /* ‚ö†Ô∏è –ê—É–¥–∏–æ –±–æ–¥–ª–æ–≥—ã–Ω —É–ª–º–∞–∞—Å —ç—Ö–ª—ç—ç–¥ —Ç–æ–≥–ª—É—É–ª–∞—Ö–≥“Ø–π ‚Äî place —Ö–∏–π—Ö “Ø–µ–¥ —Ç–æ–≥–ª—É—É–ª–Ω–∞ */
  const place=async ()=>{
    hasPlaced=true; spinSpeed=0; hint.style.display='none'; removeEventListener('pointerdown', place);
    try { vIntro.muted=false; await vIntro.play(); btnUnmute.style.display='none'; }
    catch { vIntro.muted=true; vIntro.play().catch(()=>{}); btnUnmute.style.display='inline-block'; }
    dbg('intro placed');
  };
  addEventListener('pointerdown', place, { once:true, passive:true });
  hint.style.display='block';

  vIntro.onended = ()=>{ menu.style.display='flex'; hint.style.display='none'; dbg('intro ended ‚Üí menu'); };
}

btnUnmute.addEventListener('click', async ()=>{
  try{ await currentVideo.play(); currentVideo.muted=false; btnUnmute.style.display='none'; }catch{}
});

document.getElementById('btnExercise').addEventListener('click', async ()=>{
  menu.style.display='none';
  try { await ensureCamera(); } catch {}
  if (currentVideo) currentVideo.pause();

  currentVideo = vEx;
  plane.material.map = texEx;
  hasPlaced=false; spinSpeed = 0.9*Math.PI/180; scaleFactor=1.2; applyScale();

  if (vEx.readyState>=1) fitPlaneToVideo(vEx);
  else vEx.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vEx), {once:true});

  const place2 = async ()=>{
    hasPlaced=true; spinSpeed=0; vEx.currentTime=0;
    try{ vEx.muted=false; await vEx.play(); btnUnmute.style.display='none'; }
    catch{ vEx.muted=true; vEx.play().catch(()=>{}); btnUnmute.style.display='inline-block'; }
    hint.style.display='none'; removeEventListener('pointerdown', place2);
    dbg('exercise placed & playing');
  };
  addEventListener('pointerdown', place2, { once:true, passive:true });
  hint.style.display='block';
});

document.getElementById('btnRestart').addEventListener('click', async ()=>{
  menu.style.display='none';
  if (currentVideo) currentVideo.pause();
  await startIntroFlow();
});

document.getElementById('btnCloseMenu').addEventListener('click', ()=> menu.style.display='none');

tapLay.addEventListener('pointerdown', async ()=>{
  tapLay.style.display='none';
  try{ await startIntroFlow(); }catch(e){ dbg('after tap failed: '+(e?.message||e)); }
});
</script>
</body>
</html>
