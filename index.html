<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Menu + Panels + Drag/Zoom</title>
  <style>
    :root { --z-cam:0; --z-video:2; --z-ui:5; --z-toast:6; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial}

    /* –ö–∞–º–µ—Ä */
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}

    /* 3D feel wrapper */
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:none;touch-action:none;perspective:1000px}

    /* –ê–ª—å—Ñ–∞ –≤–∏–¥–µ–æ (–¥–æ–æ–¥ —Ç”©–≤ anchor + tilt + shadow) */
    .overlay{
      position:absolute;left:50%;top:72%;
      width:clamp(38vw,58vw,75vw);height:auto;
      transform:translate(-50%,-50%) rotateX(11deg) scale(1);
      transform-origin:center center;object-fit:contain;background:transparent;display:none;pointer-events:none;
      filter:drop-shadow(0 14px 34px rgba(0,0,0,.38));
      animation:popIn .55s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes popIn{from{opacity:0;transform:translate(-50%,-40%) rotateX(16deg) scale(.86)}to{opacity:1;transform:translate(-50%,-50%) rotateX(11deg) scale(1)}}

    /* –¢”©–≤ –º–µ–Ω—é –±–∞ –ø–∞–Ω–µ–ª—å */
    .panel{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
      background:radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.45), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .card{
      width:min(92vw,460px);display:flex;flex-direction:column;gap:12px;padding:18px;
      background:rgba(255,255,255,.95);border-radius:18px;box-shadow:0 24px 50px rgba(0,0,0,.35);
      pointer-events:auto;transform:translateY(-16px);opacity:0;animation:drop .45s ease-out forwards;
    }
    @keyframes drop{from{opacity:0;transform:translateY(-24px)}to{opacity:1;transform:translateY(0)}}
    .title{font-weight:800;font-size:18px;color:#0f172a;text-align:center;margin-bottom:4px}
    .btn{padding:14px 18px;border:0;border-radius:12px;cursor:pointer;background:#111827;color:#fff;font-weight:700;font-size:15px;box-shadow:0 8px 24px rgba(0,0,0,.2)}
    .btn.alt{background:#e5e7eb;color:#111}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    /* –î—ç—ç–¥ —Ç–∞–ª—ã–Ω –±—É—Ü–∞—Ö —Ç–æ–≤—á */
    #back{
      position:fixed;right:12px;top:12px;z-index:var(--z-ui);display:none;
      padding:10px 14px;border:0;border-radius:12px;background:rgba(255,255,255,.92);color:#111;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)
    }

    /* Autoplay —Å–∞–Ω—É—É–ª–≥–∞ */
    #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.72);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
  </style>
</head>
<body>
  <!-- –ö–∞–º–µ—Ä -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- –í–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –ú–µ–Ω—é -->
  <section id="panel-menu" class="panel">
    <div class="card">
      <div class="title">–î–∞—Ä–∞–∞–≥–∏–π–Ω –∞–ª—Ö–∞–º</div>
      <button class="btn" id="go-exercise">–î–∞—Å–≥–∞–ª (Loop)</button>
      <div class="row">
        <button class="btn alt" id="go-info">–ú—ç–¥—ç—ç–ª—ç–ª</button>
        <button class="btn alt" id="go-guide">–ó–∞–∞–≤–∞—Ä</button>
      </div>
    </div>
  </section>

  <!-- Info -->
  <section id="panel-info" class="panel">
    <div class="card">
      <div class="title">–ú—ç–¥—ç—ç–ª—ç–ª</div>
      <p style="margin:0;color:#111">–≠–Ω–¥ —Ç–∞–Ω—ã —Ç–µ–∫—Å—Ç/–∑—É—Ä–≥–∏–π–≥ –±–∞–π—Ä–ª—É—É–ª–Ω–∞. –î–∞—Ä–∞–∞ –Ω—å –Ω—ç–º—ç–ª—Ç —Ç–æ–≤—á, —Ö–æ–ª–±–æ–æ—Å –Ω—ç–º–∂ –±–æ–ª–Ω–æ.</p>
      <div class="row"><button class="btn" data-back>–ë—É—Ü–∞—Ö</button></div>
    </div>
  </section>

  <!-- Guide -->
  <section id="panel-guide" class="panel">
    <div class="card">
      <div class="title">–ó–∞–∞–≤–∞—Ä</div>
      <ul style="margin:0 0 6px 18px;color:#111;line-height:1.35">
        <li>–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª ”©–≥”©—Ö</li>
        <li>Intro –¥—É—É—Å—Å–∞–Ω—ã –¥–∞—Ä–∞–∞ –º–µ–Ω—é –≥–∞—Ä–Ω–∞</li>
        <li>‚Äú–î–∞—Å–≥–∞–ª‚Äù –¥—ç—ç—Ä –¥–∞—Ä–∂ –¥–∞—Å–≥–∞–ª—ã–Ω –≤–∏–¥–µ–æ–≥ “Ø–∑–Ω—ç (loop)</li>
        <li>–í–∏–¥–µ–æ–≥ —Ö—É—Ä—É—É–≥–∞–∞—Ä —á–∏—Ä–∂ –∑”©”©–∂, —Ö–æ—ë—Ä —Ö—É—Ä—É—É–≥–∞–∞—Ä —Ç–æ–º—Ä—É—É–ª–Ω–∞/–∂–∏–∂–∏–≥–ª—ç–Ω—ç</li>
      </ul>
      <div class="row"><button class="btn" data-back>–ë—É—Ü–∞—Ö</button></div>
    </div>
  </section>

  <!-- –î—ç—ç–¥ –±—É—Ü–∞—Ö -->
  <button id="back">–ë—É—Ü–∞—Ö</button>
  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

<script>
  /* ==== –¢–ê–ù–´ –í–ò–î–ï–û URL-—É—É–¥ ==== */
  const INTRO_URL    = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
  const EXERCISE_URL = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
  // iOS –±–∞–π–≤–∞–ª HEVC+hvc1-–≥ 2 –¥–∞—Ö—å <source> –±–∞–π–¥–ª–∞–∞—Ä –Ω—ç–º—ç–∂ –±–æ–ª–Ω–æ.

  /* ==== –≠–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥ ==== */
  const cam  = document.getElementById('cam');
  const wrap = document.getElementById('overlay-wrap');
  const intro= document.getElementById('intro');
  const ex   = document.getElementById('exercise');
  const toast= document.getElementById('toast');

  const P_MENU  = document.getElementById('panel-menu');
  const P_INFO  = document.getElementById('panel-info');
  const P_GUIDE = document.getElementById('panel-guide');

  const btnBack = document.getElementById('back');
  const btnExercise = document.getElementById('go-exercise');
  const btnInfo     = document.getElementById('go-info');
  const btnGuide    = document.getElementById('go-guide');

  /* ==== –ö–∞–º–µ—Ä ==== */
  async function startCamera(){
    const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
    cam.srcObject = s; await cam.play();
  }

  /* ==== –í–∏–¥–µ–æ —ç—Ö —Å—É—Ä–≤–∞–ª–∂ ==== */
  function setVideo(el, url){
    el.innerHTML = "";
    const s = document.createElement('source');
    s.src = url; s.type = 'video/webm; codecs="vp8,opus"';
    el.appendChild(s);
  }

  /* ==== Parallax (gyro) ==== */
  let parallax = {x:0, y:0};
  if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', e=>{
      const nx = Math.max(-15, Math.min(15, e.gamma || 0)) / 15;
      const ny = Math.max(-15, Math.min(15, e.beta  || 0)) / 15;
      parallax.x = nx * 10; parallax.y = ny * 6;
      applyTransform();
    }, true);
  }

  /* ==== Drag + Zoom (bounded) ==== */
  let active=null, scale=1, startScale=1, tx=0, ty=0, sx=0, sy=0, startDist=0;
  const clamp = () => {
    const w = Math.min(window.innerWidth, 800);
    const limitX = w*0.25, limitY = 120;
    tx = Math.max(-limitX, Math.min(limitX, tx));
    ty = Math.max(-limitY, Math.min(limitY, ty));
    scale = Math.max(0.85, Math.min(1.6, scale));
  };
  function applyTransform(){
    if(!active) return; clamp();
    active.style.transform =
      `translate(calc(-50% + ${tx + parallax.x}px), calc(-50% + ${ty + parallax.y}px)) rotateX(11deg) scale(${scale})`;
  }
  function resetTransform(){ scale=1; tx=0; ty=0; applyTransform(); }
  const dist=(a,b)=>Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);

  wrap.addEventListener('mousedown', e=>{
    sx = e.clientX - tx; sy = e.clientY - ty;
    const mm = e2 => { tx = e2.clientX - sx; ty = e2.clientY - sy; applyTransform(); };
    const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); };
    window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
  });
  wrap.addEventListener('touchstart', e=>{
    if(!active) return;
    if(e.touches.length===1){ sx=e.touches[0].clientX - tx; sy=e.touches[0].clientY - ty; }
    else if(e.touches.length===2){ startDist = dist(e.touches[0], e.touches[1]); startScale = scale; }
  }, {passive:false});
  wrap.addEventListener('touchmove', e=>{
    if(!active) return; e.preventDefault();
    if(e.touches.length===1){ tx = e.touches[0].clientX - sx; ty = e.touches[0].clientY - sy; }
    else if(e.touches.length===2){ const d = dist(e.touches[0], e.touches[1]); scale = startScale * (d/startDist); }
    applyTransform();
  }, {passive:false});
  let lastTap=0;
  wrap.addEventListener('click', ()=>{ const n=Date.now(); if(n-lastTap<300) resetTransform(); lastTap=n; });

  /* ==== –ê—É–¥–∏–æ autoplay fallback ==== */
  async function playWithAudio(el){
    el.muted=false;
    try{ await el.play(); toast.style.display='none'; }
    catch{
      toast.style.display='block'; el.muted=true; el.play().catch(()=>{});
      const enable=()=>{ el.muted=false; el.volume=1; toast.style.display='none';
        document.removeEventListener('pointerdown', enable, {passive:true}); };
      document.addEventListener('pointerdown', enable, {passive:true, once:true});
    }
  }

  /* ==== –ü–∞–Ω–µ–ª—å —É–¥–∏—Ä–¥–ª–∞–≥–∞ ==== */
  function hideAllPanels(){ P_MENU.style.display='none'; P_INFO.style.display='none'; P_GUIDE.style.display='none'; }
  function showPanel(panel){ hideAllPanels(); panel.style.display='flex'; btnBack.style.display='inline-block'; }
  function showMenu(){ hideAllPanels(); P_MENU.style.display='flex'; btnBack.style.display='none'; }

  btnBack.addEventListener('click', ()=>{
    // –≤–∏–¥–µ–æ —Ç–æ–≥–ª–æ–∂ –±–∞–π–≤–∞–ª –∑–æ–≥—Å–æ–æ–≥–æ–æ–¥ –Ω—É—É—Ö
    if (!P_MENU.style.display || P_MENU.style.display==='none') {
      ex.pause(); ex.style.display='none';
      active=null;
    }
    showMenu();
  });
  // –¥–æ—Ç–æ–æ–¥ "–ë—É—Ü–∞—Ö" —Ç–æ–≤—á—É—É–¥
  document.querySelectorAll('[data-back]').forEach(b=>b.addEventListener('click', ()=>btnBack.click()));

  /* ==== –£—Ä—Å–≥–∞–ª ==== */
  async function boot(){
    try{ await startCamera(); } catch(e){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: "+e.message); return; }
    setVideo(intro, INTRO_URL); setVideo(ex, EXERCISE_URL);

    wrap.style.display='block';
    active = intro; resetTransform();
    intro.currentTime=0; intro.loop=false; intro.style.display='block';
    await playWithAudio(intro);
  }

  // Intro –¥—É—É—Å–º–∞–≥—Ü –º–µ–Ω—é
  intro.addEventListener('ended', ()=>{ intro.style.display='none'; active=null; showMenu(); });

  // –ú–µ–Ω—é —Ç–æ–≤—á–Ω—É—É–¥
  btnExercise.addEventListener('click', async ()=>{
    hideAllPanels(); btnBack.style.display='inline-block';
    ex.currentTime=0; ex.loop=true; ex.style.display='block';
    active = ex; resetTransform(); await playWithAudio(ex);
  });
  btnInfo.addEventListener('click',  ()=> showPanel(P_INFO));
  btnGuide.addEventListener('click', ()=> showPanel(P_GUIDE));

  window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
