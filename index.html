<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR — Minimal Camera</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000}
    canvas{position:fixed;inset:0;width:100vw;height:100vh;background:#000}
    #dbg{position:fixed;left:8px;top:8px;color:#0f0;font:12px monospace;
         background:rgba(0,0,0,.4);padding:6px 8px;border-radius:6px}
    #tap{position:fixed;inset:0;display:none;place-items:center;background:#000}
    .btn{padding:12px 16px;border:0;border-radius:12px;font-weight:700;cursor:pointer}
  </style>
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>
</head>
<body>
  <div id="dbg">boot…</div>
  <div id="tap"><button class="btn">▶ Камер нээх</button></div>

<script>
const dbg = (m)=>document.getElementById('dbg').textContent = m;

let THREE_, ZT, renderer, camera, scene;

async function start(){
  // 1) сангуудыг шалгах
  const t0 = Date.now();
  while (!(window.THREE && window.ZapparThree)) {
    if (Date.now()-t0 > 8000) { dbg('libs timeout'); return; }
    await new Promise(r=>setTimeout(r,100));
  }
  THREE_ = window.THREE; ZT = window.ZapparThree;

  // 2) Renderer + GL context бүртгэх (хар дэлгэцээс сэргийлнэ)
  renderer = new THREE_.WebGLRenderer({antialias:true, alpha:false, powerPreference:'high-performance'});
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);
  addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
  ZT.glContextSet(renderer.getContext());

  // 3) Камер/сцен
  camera = new ZT.Camera({ userFacing:false });
  scene  = new THREE_.Scene();
  scene.background = camera.backgroundTexture;

  // 4) Permission — Zappar overlay ашиглахгүй, зөвхөн native prompt
  const ok = await ZT.permissionRequest();
  if (!ok) { dbg('permission denied'); return; }

  try { camera.start(); } catch {}
  dbg('camera started');

  // 5) Render loop
  renderer.setAnimationLoop(()=>{
    camera.updateFrame(renderer);
    renderer.render(scene, camera);
  });

  // 6) App visibility
  document.addEventListener('visibilitychange', ()=>{
    try { document.hidden ? camera.pause() : camera.start(); } catch {}
  });
}

// iOS-ын autoplay/gesture тохиолдолд fallback
document.addEventListener('DOMContentLoaded', async ()=>{
  try { await start(); }
  catch (e){ document.getElementById('tap').style.display='grid'; dbg('tap to start'); }
});
document.getElementById('tap').addEventListener('click', async ()=>{
  document.getElementById('tap').style.display='none';
  try { await start(); } catch(e){ dbg('failed: '+(e?.message||e)); }
});
</script>
</body>
</html>
