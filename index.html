<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>WebAR World Tracking (Diag)</title>
<style>
 html,body{margin:0;height:100%;background:#000;overflow:hidden}
 #gate{position:fixed;inset:0;display:grid;place-items:center;background:#000;z-index:10}
 button{padding:14px 22px;border-radius:12px;border:0;font-size:16px}
</style>
<script src="https://libs.zappar.com/zappar-threejs/2.0.0/zappar-threejs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
</head>
<body>
<div id="gate"><button id="startBtn">Start AR</button></div>
<script>
const dbg = m => { console.log("[DEBUG]", m); };

dbg('env: https='+(location.protocol==='https:')+
    ', media='+!!navigator.mediaDevices+
    ', zappar='+!!window.ZapparThree);

async function requestCameraDiag(){
  try {
    const ok = await (window.ZapparThree?.permissionRequest?.() ?? Promise.resolve(false));
    if(ok) return dbg('permission via Zappar OK');
  } catch(e){ dbg('Zappar perm error: '+e.name); }
  try {
    const s = await navigator.mediaDevices.getUserMedia({video:true});
    s.getTracks().forEach(t=>t.stop());
    return dbg('permission via getUserMedia OK');
  } catch(e){
    dbg('getUserMedia error: '+e.name+' / '+e.message);
    throw e;
  }
}

document.getElementById('startBtn').addEventListener('click', async()=>{
  document.getElementById('gate').style.display='none';
  await requestCameraDiag();

  const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const camera = new ZapparThree.Camera();
  const scene = new THREE.Scene();
  scene.background = null;

  ZapparThree.glContextSet(renderer.getContext());
  await ZapparThree.permissionRequest();
  ZapparThree.permissionGranted().then(g=>{ if(!g) alert('Camera permission not granted'); });

  const tracker = new ZapparThree.InstantWorldTracker();
  const anchor = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
  scene.add(anchor);

  // Plane босоогоор
  const H=0.9; const W=H*(16/9);
  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(W,H),
    new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0.8,side:THREE.DoubleSide})
  );
  plane.position.y = H/2;
  anchor.add(plane);

  let hasPlaced=false;
  window.addEventListener('click',()=>{
    hasPlaced = true;
    dbg('anchor placed');
  });

  function animate(){
    requestAnimationFrame(animate);
    if(!hasPlaced) tracker.setAnchorPoseFromCameraOffset(0,0,-2);
    renderer.render(scene,camera);
  }
  animate();
});
</script>
</body>
</html>
