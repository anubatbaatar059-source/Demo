<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    #startLayer{position:fixed;inset:0;display:grid;place-items:center;z-index:var(--z-ui);background:#000}
    .btn{padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #btnUnmute{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);
           padding:6px 8px;border-radius:6px;font:12px/1.2 monospace;white-space:pre-wrap;max-width:90vw}
  </style>

  <!-- THREE + Zappar -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
  <script src="https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js" defer></script>

  <script>
    // Service worker-—É—É–¥ permission-—Ç —Å–∞–∞–¥ –±–æ–ª–æ—Ö–æ–æ—Å —Å—ç—Ä–≥–∏–π–ª–∂ –±“Ø—Ä—Ç–≥—ç–ª–≥“Ø–π –±–æ–ª–≥–æ–Ω–æ
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }
    // THREE/Zappar –±—ç–ª—ç–Ω –±–æ–ª–º–æ–≥—Ü resolve
    window.__depsReady = new Promise(res => addEventListener('load', () => {
      res({ THREE: window.THREE, ZapparThree: window.ZapparThree });
    }, { once:true }));
  </script>
</head>
<body>
  <div id="debug">DEBUG: booting‚Ä¶</div>

  <!-- UI -->
  <div id="startLayer"><button id="btnStart" class="btn" disabled>‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•</button></div>
  <button id="btnUnmute" class="btn">üîä –î—É—É–≥ –∞—Å–∞–∞—Ö</button>
  <div id="menu"><div class="menu-inner">
    <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
  </div></div>

  <!-- –ù—É—É—Ü–ª–∞–≥–¥—Å–∞–Ω <video> —ç–ª–µ–º–µ–Ω—Ç“Ø“Ø–¥ -->
  <video id="vidIntro" playsinline preload="auto" style="display:none"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none"></video>

  <script>
    /********** –¢–æ—Ö–∏—Ä–≥–æ–æ **********/
    const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const INTRO_MP4_URL      = ""; // ‚Üê –•—ç—Ä—ç–≤ fallback —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª MP4 URL —Ç–∞–≤—å
    const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const EXERCISE_MP4_URL   = ""; // ‚Üê –•—ç—Ä—ç–≤ fallback —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª MP4 URL —Ç–∞–≤—å

    const $debug = document.getElementById('debug');
    const dbg = (m)=>{
      // —Ö–∞–º–≥–∏–π–Ω —Å“Ø“Ø–ª–∏–π–Ω –ª–æ–≥ –ª —Ö–∞—Ä–∞–≥–¥–∞—Ö –±–∞–π–¥–ª–∞–∞—Ä (—Ö—ç—Ä—ç–≤ —Ö“Ø—Å–≤—ç–ª += —Ö–∏–π–∂ —Ö—É—Ä–∏–º—Ç–ª—É—É–ª–∂ –±–æ–ª–Ω–æ)
      $debug.textContent = 'DEBUG: ' + m;
      console.log('[DEBUG]', m);
    };

    const vIntro   = document.getElementById('vidIntro');
    const vEx      = document.getElementById('vidExercise');
    const startLy  = document.getElementById('startLayer');
    const btnStart = document.getElementById('btnStart');
    const btnUnmute= document.getElementById('btnUnmute');
    const menu     = document.getElementById('menu');

    const canPlay = {
      webm: !!document.createElement('video').canPlayType('video/webm; codecs="vp8,opus"'),
      mp4 : !!document.createElement('video').canPlayType('video/mp4; codecs="avc1.64001E,mp4a.40.2"') // –µ—Ä”©–Ω—Ö–∏–π H.264+AAC
    };

    function setSources(el, webm, mp4=""){
      el.crossOrigin = "anonymous";
      el.innerHTML = "";
      // –¢–æ–≥–ª–æ–∂ —á–∞–¥–∞—Ö —Ñ–æ—Ä–º–∞—Ç–∞–∞ —ç—Ö—ç–ª–∂ —Ç–∞–≤–∏–Ω–∞
      if (canPlay.webm && webm){
        const s1=document.createElement('source'); s1.src=webm; s1.type='video/webm; codecs="vp8,opus"'; el.appendChild(s1);
      } else if (canPlay.mp4 && mp4){
        const s2=document.createElement('source'); s2.src=mp4 ; s2.type='video/mp4'; el.appendChild(s2);
      }
      el.load();
    }

    /********** AR Engine **********/
    let THREE, ZapparThree, renderer, camera, scene, tracker, anchor, plane;
    let hasPlaced = false;
    let texIntro, texEx, currentVideo;

    // –ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª
    async function ensureCamera() {
      try {
        // Secure origin —à–∞–ª–≥–∞–ª—Ç
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          dbg('‚ö†Ô∏è HTTPS/localhost –±–∏—à —Ç—É–ª camera permission –±–ª–æ–∫–ª–æ–≥–¥–æ–Ω–æ');
        }
        if (window.top !== window.self) {
          dbg('‚ö†Ô∏è Iframe –¥–æ—Ç–æ—Ä –∞–∂–∏–ª–ª–∞–∂ –±–∞–π–Ω–∞ ‚Üí permission –±–ª–æ–∫–ª–æ–≥–¥–æ–∂ –º–∞–≥–∞–¥–≥“Ø–π');
        }

        const statusBefore = await (ZapparThree.permissionStatus?.() ?? Promise.resolve('unknown'));
        dbg('permission status BEFORE: ' + statusBefore);

        const ok = await ZapparThree.permissionRequest();
        dbg('permission result: ' + ok);
        if (!ok) {
          ZapparThree.permissionDeniedUI();
          throw new Error('User denied / cannot grant camera permission');
        }
        await camera.start(); // ‚Üê –∑–∞–∞–≤–∞–ª await
        dbg('camera started');
      } catch (e) {
        console.error(e);
        dbg('‚ùå ensureCamera() failed: ' + (e?.message ?? e));
        throw e;
      }
    }

    // –í–∏–¥–µ–æ ‚Üí Texture
    function videoTexture(el){
      const t = new THREE.VideoTexture(el);
      t.colorSpace = THREE.SRGBColorSpace;
      return t;
    }

    // Plane-–∞–∞ –≤–∏–¥–µ–æ–Ω—ã —Ö–∞—Ä—å—Ü–∞–∞–≥–∞–∞—Ä —Ç–∞–∞—Ä—É—É–ª–∂, –¥–æ–æ–¥ –∏—Ä–º—ç–≥–∏–π–≥ –≥–∞–∑–∞—Ä—Ç —Ç—É–ª–≥–∞—Ö
    function fitPlaneToVideo(el){
      const w = el.videoWidth  || 1280;
      const h = el.videoHeight || 720;
      const H = 0.9;                   // –±–æ—Å–æ–æ–≥–æ–æ—Ä 0.9–º ”©–Ω–¥”©—Ä
      const W = H * (w/h);
      plane.geometry.dispose();
      plane.geometry = new THREE.PlaneGeometry(W, H);
      plane.position.set(0, H/2, 0);   // –¥–æ–æ–¥ –∏—Ä–º—ç–≥ –Ω—å y=0 –¥—ç—ç—Ä —Ç–∞–∞—Ä–Ω–∞
    }

    // –ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—Ö”©–Ω yaw-–≥ –¥–∞–≥—É—É–ª–∂ –±–æ—Å–æ–æ–≥–æ–æ—Ä —Ö–∞—Ä—É—É–ª–∞—Ö (billboard, —Ö—ç–≤—Ç—ç—Ö–≥“Ø–π)
    const _eul = new THREE.Euler(0,0,0,'YXZ');
    function faceCameraYawOnly(){
      _eul.setFromQuaternion(camera.quaternion, 'YXZ');
      _eul.x = 0;          // pitch = 0  ‚Üí upright
      _eul.z = 0;          // roll  = 0
      plane.quaternion.setFromEuler(_eul);
    }

    (async function bootstrap(){
      ({ THREE, ZapparThree } = await window.__depsReady);
      if (!THREE || !ZapparThree) { alert('THREE/ZapparThree –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π'); throw new Error('Deps'); }
      if (ZapparThree.browserIncompatible()) { ZapparThree.browserIncompatibleUI(); return; }

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false, powerPreference:'high-performance' });
      renderer.setSize(innerWidth, innerHeight);
      renderer.domElement.classList.add('webgl');
      document.body.appendChild(renderer.domElement);
      addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
      ZapparThree.glContextSet(renderer.getContext());

      // –ö–∞–º–µ—Ä + Scene
      camera = new ZapparThree.Camera({ userFacing:false });
      scene  = new THREE.Scene();
      scene.background = camera.backgroundTexture;

      // Tracker + Anchor
      tracker = new ZapparThree.InstantWorldTracker();
      anchor  = new ZapparThree.InstantWorldAnchorGroup(camera, tracker);
      scene.add(anchor);

      // –ù–∏–π—Ç—ç–¥ –∞—à–∏–≥–ª–∞—Ö plane (–∞–Ω—Ö–Ω–∞–∞—Å–∞–∞ –±–æ—Å–æ–æ, —ç—Ä–≥—ç–ª—Ç–≥“Ø–π)
      plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 1),
        new THREE.MeshBasicMaterial({ transparent:true, side: THREE.DoubleSide })
      );
      plane.rotation.set(0,0,0);
      anchor.add(plane);

      // Render loop
      renderer.setAnimationLoop(()=>{
        if (!hasPlaced) {
          // –ë–∞–π—Ä–ª—É—É–ª–∞—Ö–∞–∞—Å ”©–º–Ω”© 2–º —É—Ä–¥ —Ç“Ø—Ä –±–∞—Ä–∏–Ω–∞
          tracker.setAnchorPoseFromCameraOffset(0, 0, -2);
        }
        // Plane-–∏–π–≥ upright + –∫–∞–º–µ—Ä—ã–Ω –∑“Ø–≥—Ç —Ö–∞—Ä—É—É–ª–Ω–∞
        faceCameraYawOnly();

        camera.updateFrame(renderer);
        renderer.render(scene, camera);
      });

      // Foreground/Background “Ø–µ–¥ –∫–∞–º–µ—Ä–∞–∞ —Å—ç—Ä–≥—ç—ç—Ö
      document.addEventListener('visibilitychange', async ()=>{
        try {
          if (!document.hidden) { await camera.start(); dbg('camera resumed'); }
          else { camera.pause?.(); }
        } catch(e) { dbg('resume failed: ' + (e?.message ?? e)); }
      });

      // –≠—Ö–Ω–∏–π –≤–∏–¥–µ–æ —ç—Ö “Ø“Ø—Å–≤—ç—Ä“Ø“Ø–¥–∏–π–≥ —Ç–æ–≥–ª–æ–∂ —á–∞–¥–∞—Ö —Ñ–æ—Ä–º–∞—Ç–∞–¥ —Ç–∞–∞—Ä—É—É–ª–∂ —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞
      setSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
      setSources(vEx,    EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

      // –¢–µ–∫—Å—Ç—É—Ä“Ø“Ø–¥–∏–π–≥ —É—Ä—å–¥—á–∏–ª–∞–Ω –±—ç–ª–¥—ç–Ω—ç (—Ö–æ—Ü—Ä–æ–ª—Ç –±–∞–≥–∞—Å–Ω–∞)
      texIntro = videoTexture(vIntro);
      texEx    = videoTexture(vEx);

      btnStart.disabled = false;
      dbg('bootstrap ready (press ‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•)');
    })();

    // ‚ñ∂ –≠–•–õ“Æ“Æ–õ–≠–•
    btnStart.addEventListener('click', async ()=>{
      btnStart.disabled = true; // –æ–ª–æ–Ω –¥–∞—Ä—É—É–ª–∂ –¥–∞–≤—Ö–∞—Ä —É—Ä—Å–≥–∞–ª “Ø“Ø—Å–≥—ç—Ö—ç—ç—Å —Ö–∞–º–≥–∞–∞–ª–Ω–∞
      try {
        await ensureCamera();

        currentVideo = vIntro;
        plane.material.map = texIntro;
        hasPlaced = false;

        if (vIntro.readyState >= 1) fitPlaneToVideo(vIntro);
        else vIntro.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vIntro), { once:true });

        try {
          vIntro.muted = false;
          await vIntro.play();
          btnUnmute.style.display = 'none';
        } catch (e) {
          // Autoplay block ‚Üí muted autoplay + unmute —Ç–æ–≤—á
          dbg('autoplay blocked: ' + (e?.message ?? e));
          vIntro.muted = true;
          await vIntro.play().catch(()=>{});
          btnUnmute.style.display = 'inline-block';
        }

        const placeIntro = ()=>{
          hasPlaced = true;
          removeEventListener('pointerdown', placeIntro);
          dbg('intro placed');
        };
        addEventListener('pointerdown', placeIntro, { once:true, passive:true });

        startLy.style.display='none';
        dbg('intro playing (tap to place). When ended ‚Üí menu');

        vIntro.onended = () => { menu.style.display = 'flex'; dbg('intro ended ‚Üí menu'); };
      } catch (e) {
        console.error(e);
        dbg('camera permission was denied or failed');
        btnStart.disabled = false; // –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–∂ –±–æ–ª–Ω–æ
      }
    });

    // –î—É—É–≥ –∞—Å–∞–∞—Ö
    btnUnmute.addEventListener('click', async ()=>{
      try{
        await currentVideo.play();
        currentVideo.muted=false;
        btnUnmute.style.display='none';
      } catch(e){
        dbg('unmute failed: ' + (e?.message ?? e));
      }
    });

    // ‚Äû–î–∞—Å–≥–∞–ª‚Äú
    document.getElementById('btnExercise').addEventListener('click', async ()=>{
      menu.style.display = 'none';
      try { await ensureCamera(); } catch {}

      if (currentVideo) currentVideo.pause();
      currentVideo = vEx;
      plane.material.map = texEx;
      hasPlaced = false;

      if (vEx.readyState >= 1) fitPlaneToVideo(vEx);
      else vEx.addEventListener('loadedmetadata', ()=>fitPlaneToVideo(vEx), { once:true });

      const onFirstTap = ()=>{
        hasPlaced = true;
        vEx.currentTime = 0;
        vEx.muted = false;
        vEx.play().catch(()=>{});
        removeEventListener('pointerdown', onFirstTap);
        dbg('exercise placed & playing');
      };
      addEventListener('pointerdown', onFirstTap, { once:true, passive:true });

      dbg('exercise ready (tap to place & play)');
    });
  </script>
</body>
</html>
