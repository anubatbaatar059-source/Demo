<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî World Placement (WebXR Hit Test)</title>

  <style>
    :root { --z-ui:5; --z-menu:6; --z-debug:20; --z-help:25 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    canvas.webgl{position:fixed;inset:0;width:100vw;height:100vh;background:#000}

    .btn{padding:12px 16px;border:0;border-radius:12px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25);transition:transform .2s ease}
    .btn:hover{transform:scale(1.05)} .btn:active{transform:scale(.95)}
    #btnUnmute{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);z-index:var(--z-ui);display:none}

    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu);background:rgba(0,0,0,.8)}
    .menu-inner{display:flex;flex-direction:column;gap:12px;padding:16px;border-radius:16px;background:rgba(255,255,255,.08);backdrop-filter:blur(10px);width:min(90vw,420px)}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.7);
           padding:8px 12px;border-radius:8px;font:12px/1.35 monospace;white-space:pre-wrap;max-width:90vw;border:1px solid rgba(0,255,0,.3)}

    #loadingScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:var(--z-ui);
                   background:#000;flex-direction:column;gap:16px}
    .spinner{width:46px;height:46px;border:4px solid rgba(255,255,255,.3);border-top:4px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    #permissionError{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-ui);
                     background:#000;flex-direction:column;gap:16px;text-align:center;padding:20px;color:#fff}

    #help{position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:var(--z-help);
          background:rgba(0,0,0,.55);color:#fff;padding:8px 12px;border-radius:999px;font-size:14px;line-height:1.3;display:none}
    #help b{font-weight:700}
  </style>

  <!-- THREE only -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js" defer></script>
</head>
<body>
  <div id="debug">DEBUG: Initializing‚Ä¶</div>

  <div id="loadingScreen">
    <div class="spinner"></div>
    <h2 style="color:#fff;margin:0;">Starting AR‚Ä¶</h2>
    <p style="color:#bbb;margin:0;">Move your phone to find a surface</p>
  </div>

  <div id="permissionError">
    <h2>Camera Access Required</h2>
    <p>This AR experience needs camera access.</p>
    <button id="btnRetry" class="btn">Try Again</button>
  </div>

  <div id="help">üü° Move phone to find a surface ‚Ä¢ <b>Tap</b> to place ‚Ä¢ <b>Pinch</b> to scale ‚Ä¢ <b>Rotate</b> with two fingers</div>

  <button id="btnUnmute" class="btn">üîä Enable Audio</button>

  <div id="menu">
    <div class="menu-inner">
      <h3 style="color:#fff;margin:0 0 8px 0;text-align:center;">Select Experience</h3>
      <div class="row">
        <button class="btn" id="btnExercise">Start Exercise</button>
        <button class="btn" id="btnRestart">Restart Intro</button>
        <button class="btn" id="btnResetPlace" style="background:#ffe47a;">Re-place Object</button>
      </div>
    </div>
  </div>

  <!-- Hidden video elements -->
  <video id="vidIntro" playsinline preload="auto" style="display:none" crossorigin="anonymous"></video>
  <video id="vidExercise" playsinline preload="auto" loop style="display:none" crossorigin="anonymous"></video>

<script>
/* ===== Config ===== */
const INTRO_WEBM_URL     = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
const INTRO_MP4_URL      = ""; // optional MP4 fallback if needed
const EXERCISE_WEBM_URL  = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
const EXERCISE_MP4_URL   = ""; // optional MP4 fallback

/* ===== DOM ===== */
const vIntro = document.getElementById('vidIntro');
const vExercise = document.getElementById('vidExercise');
const loadingScreen = document.getElementById('loadingScreen');
const permissionError = document.getElementById('permissionError');
const btnRetry = document.getElementById('btnRetry');
const btnUnmute = document.getElementById('btnUnmute');
const menu = document.getElementById('menu');
const help = document.getElementById('help');

const dbg = (m)=>{ console.log('[DEBUG]', m); document.getElementById('debug').textContent = 'DEBUG: ' + m; };

/* ===== Video helpers ===== */
function setupVideoSources(video, webmUrl, mp4Url=""){
  video.innerHTML = "";
  if(webmUrl){
    const s=document.createElement('source');
    s.src=webmUrl; s.type='video/webm; codecs="vp8,opus"';
    video.appendChild(s);
  }
  if(mp4Url){
    const s=document.createElement('source');
    s.src=mp4Url; s.type='video/mp4';
    video.appendChild(s);
  }
  video.setAttribute('playsinline','true');
  video.setAttribute('webkit-playsinline','true');
  video.preload='auto';
  video.load();
}

function createVideoTexture(video){
  const tex = new THREE.VideoTexture(video);
  tex.colorSpace = THREE.SRGBColorSpace;
  tex.flipY = false;
  tex.minFilter = THREE.LinearFilter;
  tex.magFilter = THREE.LinearFilter;
  tex.generateMipmaps = false;
  return tex;
}

async function playVideoWithAudio(video){
  try{
    if(video.readyState < 2){
      await new Promise(res=>video.addEventListener('canplay', res, { once:true }));
    }
    video.muted=false;
    await video.play();
    btnUnmute.style.display='none';
  }catch(e){
    video.muted=true;
    try{
      await video.play();
      btnUnmute.style.display='inline-block';
      dbg('Autoplay blocked: showing Unmute button');
    }catch(e2){
      dbg('Video play failed: '+e2.message);
    }
  }
}

/* ===== Three.js + WebXR ===== */
let renderer, scene, camera;
let plane, reticle;
let introTexture, exerciseTexture, currentVideo;

let xrSession, xrRefSpace, viewerSpace, hitTestSource;
let placed = false;

// gesture state
let pinchStartDist = 0, startScale = 1;
let startAngle = 0, startRotationY = 0;

function adjustPlaneToVideo(video){
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  const displayH = 1.0; // meters
  const displayW = displayH * (w / h);

  plane.geometry.dispose();
  plane.geometry = new THREE.PlaneGeometry(displayW, displayH, 32, 32);
  // –±–∞–≥–∞ –∑—ç—Ä—ç–≥ –¥–æ–æ—à —Ç–æ–Ω–≥–æ–π–ª–≥–æ–∂ (—à–∞–ª–∞–Ω –¥—ç—ç—Ä –Ω–∞–∞—Å–∞–Ω –º—ç–¥—Ä—ç–º–∂)
  plane.rotation.x = -0.15;
  dbg(`Plane size: ${displayW.toFixed(2)} x ${displayH.toFixed(2)} m`);
}

async function initThree(){
  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.domElement.classList.add('webgl');
  document.body.appendChild(renderer.domElement);
  renderer.xr.enabled = true;

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.01, 100);

  window.addEventListener('resize', ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  });

  // –í–∏–¥–µ–æ–≥ “Ø–∑“Ø“Ø–ª—ç—Ö —Ö–∞–≤—Ç–≥–∞–π
  plane = new THREE.Mesh(
    new THREE.PlaneGeometry(1,1,16,16),
    new THREE.MeshBasicMaterial({ transparent:true, side:THREE.DoubleSide, alphaTest:0.1 })
  );
  plane.visible = false;
  scene.add(plane);

  // Reticle ‚Äî –≥–∞–∑–∞—Ä –æ–ª–¥—Å–æ–Ω “Ø–µ–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞
  const ring = new THREE.RingGeometry(0.07,0.085,40);
  ring.rotateX(-Math.PI/2);
  reticle = new THREE.Mesh(ring, new THREE.MeshBasicMaterial({transparent:true, opacity:0.9}));
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);
}

async function startXR(){
  if(!('xr' in navigator)) throw new Error('WebXR not supported in this browser');

  xrSession = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test','dom-overlay'],
    domOverlay: { root: document.body }
  });

  await renderer.xr.setSession(xrSession);
  xrRefSpace = await xrSession.requestReferenceSpace('local');
  viewerSpace = await xrSession.requestReferenceSpace('viewer');
  hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });

  help.style.display = 'block';

  // tap ‚Üí –±–∞–π—Ä–ª—É—É–ª–∞—Ö
  window.addEventListener('pointerdown', onPlaceTap);

  // gestures: pinch & rotate
  window.addEventListener('pointerdown', onPointerDown);
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp);
  window.addEventListener('pointercancel', onPointerUp);
  window.addEventListener('lostpointercapture', onPointerUp);

  const pointers = new Map();
  function onPointerDown(e){ pointers.set(e.pointerId, e); if(pointers.size===2) beginGesture(); }
  function onPointerMove(e){
    if(pointers.has(e.pointerId)){ pointers.set(e.pointerId,e); if(pointers.size===2) updateGesture(); }
  }
  function onPointerUp(e){ pointers.delete(e.pointerId); if(pointers.size<2) endGesture(); }

  function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
  function angle(a,b){ return Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX); }

  function beginGesture(){
    if(!placed) return;
    const [a,b] = [...pointers.values()];
    pinchStartDist = dist(a,b);
    startAngle = angle(a,b);
    startScale = plane.scale.x;
    startRotationY = plane.rotation.y;
  }
  function updateGesture(){
    if(!placed) return;
    const [a,b] = [...pointers.values()];
    const d = dist(a,b);
    const ang = angle(a,b);
    const scale = THREE.MathUtils.clamp(startScale * (d / (pinchStartDist||d)), 0.5, 3.0);
    plane.scale.setScalar(scale);
    plane.rotation.y = startRotationY + (ang - startAngle);
  }
  function endGesture(){ /* noop */ }

  // render loop
  renderer.setAnimationLoop((t, frame)=>{
    if(!frame){ renderer.render(scene,camera); return; }

    const pose = frame.getViewerPose(xrRefSpace);
    if(!pose){ renderer.render(scene,camera); return; }

    // hit-test –∑”©–≤—Ö”©–Ω –±–∞–π—Ä–ª—É—É–ª–∞–∞–≥“Ø–π “Ø–µ–¥ –≥“Ø–π—Ü—ç—Ç–≥—ç–Ω—ç
    if(!placed){
      const hits = frame.getHitTestResults(hitTestSource);
      if(hits.length>0){
        const hit = hits[0];
        const hitPose = hit.getPose(xrRefSpace);
        reticle.visible = true;
        reticle.matrix.fromArray(hitPose.transform.matrix);
      }else{
        reticle.visible = false;
      }
    }

    renderer.render(scene,camera);
  });

  function onPlaceTap(e){
    if(placed || !reticle.visible) return;
    // reticle-–∏–π–Ω –º–∞—Ç—Ä–∏—Ü—ã–≥ plane-–¥ —Ö—É—É–ª–∂ —Ç–∞–≤–∏–Ω–∞ (–≥–∞–∑–∞—Ä—Ç ‚Äú–Ω–∞–∞–Ω–∞‚Äù)
    reticle.matrix.decompose(plane.position, plane.quaternion, plane.scale);
    plane.visible = true;
    placed = true;
    help.style.display='none';
    dbg('Placed on surface');
  }
}

/* ===== App flow ===== */
let currentTexture;

async function startApp(){
  try{
    // –í–∏–¥–µ–æ–Ω—É—É–¥ –±—ç–ª–¥—ç–Ω—ç
    setupVideoSources(vIntro, INTRO_WEBM_URL, INTRO_MP4_URL);
    setupVideoSources(vExercise, EXERCISE_WEBM_URL, EXERCISE_MP4_URL);

    introTexture    = introTexture    || createVideoTexture(vIntro);
    exerciseTexture = exerciseTexture || createVideoTexture(vExercise);

    currentVideo = vIntro;
    currentTexture = introTexture;
    plane.material.map = currentTexture;

    if (vIntro.readyState >= 1) adjustPlaneToVideo(vIntro);
    else vIntro.addEventListener('loadedmetadata', ()=>adjustPlaneToVideo(vIntro), { once:true });

    loadingScreen.style.display='none';

    await startXR();         // WebXR + HitTest —ç—Ö–ª“Ø“Ø–ª–Ω—ç
    await playVideoWithAudio(vIntro); // –í–∏–¥–µ–æ —Ç–æ–≥–ª—É—É–ª–∂ —ç—Ö—ç–ª–Ω—ç
  }catch(e){
    console.error(e);
    loadingScreen.style.display='none';
    permissionError.style.display='flex';
  }
}

/* ===== UI ===== */
btnRetry.addEventListener('click', ()=>{
  permissionError.style.display='none';
  loadingScreen.style.display='flex';
  location.reload();
});

btnUnmute.addEventListener('click', async ()=>{
  if(currentVideo){
    try{ currentVideo.muted=false; await currentVideo.play(); btnUnmute.style.display='none'; }
    catch(e){ dbg('Unmute failed: '+e.message); }
  }
});

document.getElementById('btnExercise').addEventListener('click', async ()=>{
  try{
    menu.style.display='none';
    if(currentVideo) currentVideo.pause();
    currentVideo = vExercise;
    plane.material.map = exerciseTexture;

    if (vExercise.readyState >= 1) adjustPlaneToVideo(vExercise);
    else vExercise.addEventListener('loadedmetadata', ()=>adjustPlaneToVideo(vExercise), { once:true });

    vExercise.currentTime = 0;
    await playVideoWithAudio(vExercise);
    dbg('Exercise playing');
  }catch(e){ dbg('Exercise failed: '+e.message); }
});

document.getElementById('btnRestart').addEventListener('click', async ()=>{
  try{
    menu.style.display='none';
    if(currentVideo) currentVideo.pause();
    currentVideo = vIntro;
    plane.material.map = introTexture;
    vIntro.currentTime = 0;
    await playVideoWithAudio(vIntro);
    dbg('Intro restarted');
  }catch(e){ dbg('Restart failed: '+e.message); }
});

document.getElementById('btnResetPlace').addEventListener('click', ()=>{
  placed = false;
  help.style.display='block';
  dbg('Placement reset ‚Äî move phone to find surface, then tap to place');
});

// –ò–Ω—Ç—Ä–æ –¥—É—É—Å–º–∞–≥—Ü –º–µ–Ω—é –≥–∞—Ä–≥–∞–Ω–∞
vIntro.onended = ()=>{ menu.style.display='flex'; dbg('Intro ended ‚Üí menu'); };

// Boot
window.addEventListener('load', async ()=>{
  await initThree();
  await startApp();
});
</script>
</body>
</html>
