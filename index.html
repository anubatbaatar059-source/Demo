<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
  <title>WebAR ‚Äî Zappar (Intro ‚Üí –ú–µ–Ω—é ‚Üí –î–∞—Å–≥–∞–ª)</title>

  <style>
    :root { --z-cam:0; --z-canvas:10; --z-video:2; --z-menu:3; --z-toast:4; --z-debug:20 }
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui,Arial,sans-serif}
    #cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:var(--z-cam);transform:scaleX(-1)}
    #overlay-wrap{position:fixed;inset:0;z-index:var(--z-video);display:block;touch-action:none}
    .overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:transparent;display:none}
    #menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:var(--z-menu)}
    .menu-inner{display:flex;flex-direction:column;gap:12px}
    .btn{width:200px;padding:14px 18px;border:0;border-radius:14px;cursor:pointer;background:#fff;color:#111;font-weight:700;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:var(--z-toast);background:rgba(0,0,0,.7);color:#fff;border-radius:10px;padding:10px 14px;font-size:13px;display:none}
    #debug{position:fixed;left:10px;top:10px;z-index:var(--z-debug);color:#0f0;background:rgba(0,0,0,.5);padding:6px 8px;border-radius:6px;font:12px/1.2 monospace;white-space:pre-wrap;max-width:90vw}
  </style>

  <script>
    // Service worker –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π ‚Üí —Å–∞–ª–≥–∞—è
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then(rs => rs.forEach(r => r.unregister()));
    }

    // ZapparThree-–≥ —ç—Ö–ª—ç—ç–¥ LOCAL-–∞–∞—Å, –±“Ø—Ç—ç–ª–≥“Ø–π–¥–≤—ç–ª CDN-—ç—ç—Å –∞—á–∞–∞–ª–∂ –¥—É—É—Å—Ç–∞–ª –Ω—å —Ö“Ø–ª—ç—ç—Ö Promise
    window.__zapparReady = new Promise((resolve, reject) => {
      const done = () => window.ZapparThree && resolve(window.ZapparThree);

      const loadCDN = () => {
        const cdn = document.createElement('script');
        cdn.src = "https://unpkg.com/@zappar/zappar-threejs@2.5.2/umd/zappar-threejs.js";
        cdn.defer = true;
        cdn.onload = done;
        cdn.onerror = () => reject(new Error("CDN load failed"));
        document.head.appendChild(cdn);
      };

      const local = document.createElement('script');
      local.src = "./vendor/zappar-threejs.js";
      local.defer = true;
      local.onload = () => window.ZapparThree ? resolve(window.ZapparThree) : loadCDN();
      local.onerror = loadCDN;
      document.head.appendChild(local);
    });
  </script>

  <!-- THREE-–≥ –≥–ª–æ–±–∞–ª–∞–∞—Ä –∞—á–∞–∞–ª–Ω–∞ (module –±–∏—à) -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
</head>
<body>
  <div id="debug">DEBUG: booting‚Ä¶</div>

  <!-- –ö–∞–º–µ—Ä—ã–Ω —ç—Ö–Ω–∏–π preview (AR –∞—Å–∞–∞—Ö–∞–∞—Å ”©–º–Ω”©) -->
  <video id="cam" playsinline autoplay muted></video>

  <!-- –î—ç—ç—Ä –¥–∞–≤—Ö–∞—Ä–ª–∞—Ö DOM –≤–∏–¥–µ–æ–Ω—É—É–¥ -->
  <div id="overlay-wrap">
    <video id="intro" class="overlay" playsinline></video>
    <video id="exercise" class="overlay" playsinline loop></video>
  </div>

  <!-- –ú–µ–Ω—é -->
  <div id="menu">
    <div class="menu-inner">
      <button class="btn" id="btnInfo">–ú—ç–¥—ç—ç–ª—ç–ª</button>
      <button class="btn" id="btnGuide">–ó–∞–∞–≤–∞—Ä</button>
      <button class="btn" id="btnExercise">–î–∞—Å–≥–∞–ª</button>
    </div>
  </div>

  <div id="toast">üîä –î—É—É–≥ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö–∏–π–Ω —Ç—É–ª–¥ –¥—ç–ª–≥—ç—Ü –¥—ç—ç—Ä –Ω—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</div>

  <script>
    const INTRO_URL        = "https://batbaatar-anu.github.io/my-ar-host/output_alpha_audio.webm";
    const EXERCISE_URL     = "https://batbaatar-anu.github.io/my-ar-host/dasgal.webm";
    const MP4_EXERCISE_URL = ""; // iOS fallback MP4 —Ö—ç—Ä—ç–≥—Ç—ç–π –±–æ–ª —ç–Ω–¥ —Ç–∞–≤–∏–Ω–∞

    const dbg = (m) => { document.getElementById('debug').textContent = 'DEBUG: ' + m; };
    window.dbg = dbg; // –≥–ª–æ–±–∞–ª –±–æ–ª–≥–æ—ë

    const cam   = document.getElementById('cam');
    const intro = document.getElementById('intro');
    const exercise = document.getElementById('exercise');
    const menu  = document.getElementById('menu');
    const toast = document.getElementById('toast');

    let audioCtx;
    async function ensureAudioFromStart(){
      try{
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if(!Ctx) return;
        if(!audioCtx) audioCtx = new Ctx();
        if(audioCtx.state === 'suspended'){ await audioCtx.resume().catch(()=>{}); }
      }catch(e){ dbg('AudioCtx err'); }
    }

    async function startCamera(){
      const stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ ideal:'environment' } },
        audio:false
      });
      cam.srcObject = stream; await cam.play();
      dbg('getUserMedia started');
    }
    async function stopCam(){
      try{
        if(cam.srcObject){ cam.srcObject.getTracks().forEach(t=>t.stop()); }
        cam.srcObject = null; cam.style.display = 'none';
        dbg('getUserMedia stopped');
      }catch(e){ dbg('stopCam err'); }
    }
    window.stopCam = stopCam;

    function setSources(videoEl, webmUrl, mp4Url=""){
      videoEl.innerHTML = "";
      videoEl.crossOrigin = "anonymous";
      videoEl.preload = "auto";
      if (webmUrl){ const s1=document.createElement('source'); s1.src=webmUrl; s1.type='video/webm; codecs="vp8,opus"'; videoEl.appendChild(s1); }
      if (mp4Url){ const s2=document.createElement('source'); s2.src=mp4Url; s2.type='video/mp4'; videoEl.appendChild(s2); }
      videoEl.load();
    }

    async function boot(){
      try{ await startCamera(); await ensureAudioFromStart(); }
      catch(err){ alert("–ö–∞–º–µ—Ä—ã–Ω –∑”©–≤—à”©”©—Ä”©–ª —Ö—ç—Ä—ç–≥—Ç—ç–π: " + err.message); dbg('boot fail'); return; }

      setSources(intro, INTRO_URL);
      setSources(exercise, EXERCISE_URL, MP4_EXERCISE_URL);

      intro.currentTime = 0; intro.style.display = "block"; intro.muted = false;
      try{
        await intro.play();
        toast.style.display = "none"; dbg('intro playing');
      }catch(e){
        toast.style.display = "block"; intro.muted = true; intro.play().catch(()=>{});
        const enableAudio = ()=>{
          intro.muted = false; toast.style.display = "none";
          document.removeEventListener('pointerdown', enableAudio, {passive:true});
        };
        document.addEventListener('pointerdown', enableAudio, {passive:true, once:true});
        dbg('intro autoplay blocked (tap to enable)');
      }
    }
    window.boot = boot;

    intro.addEventListener('ended', ()=>{
      intro.style.display = "none";
      menu.style.display = "flex";
      dbg('intro ended ‚Üí menu');
    });

    window.addEventListener('DOMContentLoaded', window.boot);
  </script>

  <!-- ===== AR –ª–æ–≥–∏–∫ (module –±–∏—à) ===== -->
  <script>
    (function () {
      const btn = document.getElementById('btnExercise');
      btn.addEventListener('click', onExerciseClick);

      async function onExerciseClick () {
        window.dbg('btnExercise clicked');

        // ZapparThree local/CDN –∞–ª—å –Ω—å —á –±–∞–π –∞—á–∞–∞–ª—Ç–∞–ª —Ö“Ø–ª—ç—ç–µ
        let ZapparThree;
        try {
          ZapparThree = await window.__zapparReady;
        } catch (e) {
          alert('ZapparThree –∞—á–∞–∞–ª–∞–≥–¥—Å–∞–Ω–≥“Ø–π (–ª–æ–∫–∞–ª/CDN).');
          return;
        }

        // UI –Ω—É—É—Ö
        document.getElementById('menu').style.display = 'none';
        const wrap = document.getElementById('overlay-wrap');
        wrap.style.display = 'none';
        wrap.style.pointerEvents = 'none';

        await window.stopCam();

        // THREE-–≥ –≥–ª–æ–±–∞–ª–∞–∞—Å
        const THREE = window.THREE;

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        Object.assign(renderer.domElement.style, {
          position:'fixed', inset:'0', width:'100vw', height:'100vh',
          zIndex:'10', background:'transparent'
        });
        window.addEventListener('resize', () => renderer.setSize(window.innerWidth, window.innerHeight));

        // Zappar GL context
        ZapparThree.glContextSet(renderer.getContext());

        // Browser check
        if (ZapparThree.browserIncompatible()) { ZapparThree.browserIncompatibleUI(); return; }

        // Camera + Scene
        const camera = new ZapparThree.Camera({ userFacing:false });
        const scene  = new THREE.Scene();
        scene.background = camera.backgroundTexture;

        const granted = await ZapparThree.permissionRequest();
        if (!granted) { ZapparThree.permissionDeniedUI(); return; }
        camera.start();
        window.dbg('zappar camera started');

        // Instant World Tracking
        const instantTracker = new ZapparThree.InstantWorldTracker();
        const anchorGroup = new ZapparThree.InstantWorldAnchorGroup(camera, instantTracker);
        scene.add(anchorGroup);

        // –í–∏–¥–µ–æ —Ç–µ–∫—Å—Ç—É—Ä
        const exerciseEl = document.getElementById('exercise');
        const tex = new THREE.VideoTexture(exerciseEl);
        tex.encoding = THREE.sRGBEncoding;

        // –í–∏–¥–µ–æ–Ω—ã —Ö–∞—Ä—å—Ü–∞–∞–≥–∞–∞—Ä —Ö–∞–≤—Ç–≥–∞–π
        const makePlane = () => {
          const w = exerciseEl.videoWidth || 1280;
          const h = exerciseEl.videoHeight || 720;
          const height = 0.7;               // –º
          const width  = height * (w / h);
          return new THREE.Mesh(
            new THREE.PlaneGeometry(width, height),
            new THREE.MeshBasicMaterial({ map: tex, transparent:true, side: THREE.DoubleSide })
          );
        };

        let plane = makePlane();
        plane.rotation.x = -Math.PI/2;
        anchorGroup.add(plane);

        exerciseEl.addEventListener('loadedmetadata', () => {
          anchorGroup.remove(plane);
          plane.geometry.dispose(); plane.material.dispose();
          plane = makePlane();
          plane.rotation.x = -Math.PI/2;
          anchorGroup.add(plane);
        }, { once:true });

        // Render loop
        let placed = false;
        renderer.setAnimationLoop(() => {
          if (!placed) instantTracker.setAnchorPoseFromCameraOffset(0, 0, -2);
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        });

        // –≠—Ö–Ω–∏–π tap ‚Üí –±–∞–π—Ä–ª—É—É–ª–∂, –¥—É—É–≥–∞–∞—Ä —Ç–æ–≥–ª—É—É–ª–Ω–∞
        const onFirstTap = () => {
          placed = true;
          exerciseEl.muted = false;
          exerciseEl.currentTime = 0;
          exerciseEl.play().catch(()=>{});
          window.removeEventListener('pointerdown', onFirstTap);
        };
        window.addEventListener('pointerdown', onFirstTap, { once:true, passive:true });
      }
    })();
  </script>
</body>
</html>
